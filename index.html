<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase (vers√µes mais recentes) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* PLANO DE FUNDO PONTILHADO */
            background-color: #0d1117; /* Cor de fundo escura */
            background-image: radial-gradient(circle, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 1.5rem 1.5rem; /* Espa√ßamento dos pontos */
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.5); /* Um pouco mais opaco para legibilidade */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: border-color 0.3s;
        }
        .glass-input, .glass-select {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
        }
        .glass-input::placeholder, .glass-select::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        .glass-select option {
            background: #1e293b; /* slate-800 */
            color: white;
        }
        .tab-button.active {
            border-color: #818cf8; /* indigo-400 */
            color: white;
            background-color: rgba(79, 70, 229, 0.2);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* Estilos para o Modal Customizado */
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="text-white">

    <!-- ===== TELA DE CARREGAMENTO ===== -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900/80 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-indigo-400"></div>
        <p class="text-2xl ml-4">Carregando...</p>
    </div>

    <!-- ===== CONTAINER DE MODAL/ALERTA ===== -->
    <div id="modal-backdrop" class="modal-backdrop fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4 hidden opacity-0">
        <div class="modal-content glass-card w-full max-w-md p-6 rounded-2xl shadow-2xl transform scale-95">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Aten√ß√£o</h3>
            <div id="modal-message" class="text-white/80 mb-6">Mensagem do modal.</div>
            <div id="modal-input-container" class="mb-4 hidden">
                <input type="text" id="modal-input" class="glass-input w-full p-3 rounded-xl" placeholder="Digite para confirmar">
            </div>
            <div id="modal-buttons" class="flex justify-end gap-4">
                <button id="modal-cancel-button" class="bg-white/10 hover:bg-white/20 font-bold py-2 px-6 rounded-xl transition">Cancelar</button>
                <button id="modal-confirm-button" class="bg-indigo-500 hover:bg-indigo-600 font-bold py-2 px-6 rounded-xl transition">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- ===== CONTAINER DE TOAST/NOTIFICA√á√ÉO ===== -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50"></div>


    <!-- Container Principal da Aplica√ß√£o -->
    <div id="app-root" class="min-h-screen">
        <!-- O conte√∫do (Login ou App) ser√° injetado aqui pelo JavaScript -->
    </div>

    <script>
        // =================================================================================
        // üî¥ ATEN√á√ÉO: CONFIGURA√á√ÉO DO FIREBASE E REGRAS DE SEGURAN√áA
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBJOANW80V8EyUQ3LbNqwJ8-91DfIp5ho8",
            authDomain: "gerenciadorturma.firebaseapp.com",
            projectId: "gerenciadorturma",
            storageBucket: "gerenciadorturma.appspot.com",
            messagingSenderId: "610656492633",
            appId: "1:610656492633:web:32a0451c02048b6b1fe548",
            measurementId: "G-5JZXJSMGGL"
        };

        // Inicializa√ß√£o do Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Elementos Globais do DOM
        const loadingOverlay = document.getElementById('loading-overlay');
        const appRoot = document.getElementById('app-root');
        let userCache = {};
        let currentUnsubscribes = []; // Para limpar listeners do Firestore

        // --- FUN√á√ïES DE UI (MODAL E TOAST) ---
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            toast.className = `p-4 rounded-xl shadow-lg text-white ${colors[type]} transition-all duration-300 transform translate-y-4 opacity-0`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => { toast.classList.remove('translate-y-4', 'opacity-0'); }, 10);
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }
        
        function showModal(message, title = 'Aten√ß√£o', options = { isConfirm: false, withInput: false }) {
            return new Promise((resolve) => {
                const backdrop = document.getElementById('modal-backdrop');
                const content = document.querySelector('.modal-content');
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-message').innerHTML = message;

                const confirmBtn = document.getElementById('modal-confirm-button');
                const cancelBtn = document.getElementById('modal-cancel-button');
                const inputContainer = document.getElementById('modal-input-container');
                const input = document.getElementById('modal-input');

                cancelBtn.style.display = options.isConfirm ? 'block' : 'none';
                confirmBtn.textContent = options.isConfirm ? 'Confirmar' : 'OK';
                inputContainer.style.display = options.withInput ? 'block' : 'none';
                input.value = '';
                
                backdrop.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    content.classList.remove('scale-95');
                }, 10);

                const close = (value) => {
                    backdrop.classList.add('opacity-0');
                    content.classList.add('scale-95');
                    backdrop.addEventListener('transitionend', () => backdrop.classList.add('hidden'), { once: true });
                    resolve(options.withInput ? { confirmed: value, value: input.value } : value);
                };

                confirmBtn.onclick = () => close(true);
                cancelBtn.onclick = () => close(false);
            });
        }


        // --- FUN√á√ïES DE TEMPLATE HTML ---
        function getAuthShellHTML() {
            return `<div class="flex-grow flex items-center justify-center min-h-screen p-4"><div class="w-full max-w-md"><div class="glass-card p-8 rounded-2xl shadow-2xl"><div class="mb-6 text-center">
            <img src="https://i.imgur.com/0S7XZFz.png" alt="Logo" class="h-12 mx-auto mb-4">
            <p class="text-white/70">Bem-vindo(a)!</p></div><div class="flex border-b border-white/20 mb-6"><button id="login-tab-button" class="tab-button flex-1 py-3 font-semibold border-b-2 transition-colors duration-300">Login</button><button id="register-tab-button" class="tab-button flex-1 py-3 font-semibold border-b-2 border-transparent text-white/60 transition-colors duration-300">Cadastro</button></div><div><div id="login-tab-content" style="display: none;"><form id="login-form" class="space-y-6"><input type="email" id="login-email" placeholder="Email" class="glass-input w-full py-3 px-4 rounded-xl" required><input type="password" id="login-password" placeholder="Senha" class="glass-input w-full py-3 px-4 rounded-xl" required><button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 font-bold py-3 px-4 rounded-xl transition">Entrar</button></form></div><div id="register-tab-content" style="display: none;"><form id="register-form" class="space-y-6"><input type="text" id="register-name" placeholder="Nome Completo" class="glass-input w-full py-3 px-4 rounded-xl" required><input type="email" id="register-email" placeholder="Email" class="glass-input w-full py-3 px-4 rounded-xl" required><input type="password" id="register-password" placeholder="Senha (m√≠nimo 6 caracteres)" class="glass-input w-full py-3 px-4 rounded-xl" required><button type="submit" class="w-full bg-green-500 hover:bg-green-600 font-bold py-3 px-4 rounded-xl transition">Cadastrar</button></form></div></div></div></div></div>`;
        }

        function getAppShellHTML() {
            return `<div class="container mx-auto p-4 md:p-8 flex flex-col"><header id="main-header" class="flex justify-between items-center mb-8">
            <img src="https://i.imgur.com/0S7XZFz.png" alt="Logo" class="h-10 cursor-pointer" onclick="goHome()">
            <div class="flex items-center gap-4"><span id="user-email" class="text-white/80 hidden md:block"></span><div id="admin-button-container"></div><button id="logout-button" class="bg-red-500/50 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-xl transition">Sair</button></div></header><main id="app-main-view"></main></div>`;
        }

        function getDashboardHTML() {
            return `<div class="flex justify-center gap-4 mb-8"><button onclick="renderView('os-create-page')" class="bg-blue-500/80 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition">+ Cadastrar Nova O.S.</button><button onclick="renderView('laudo-create-page')" class="bg-indigo-500/80 hover:bg-indigo-500 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition">+ Cadastrar Novo Laudo</button></div><div><h2 class="text-2xl font-semibold mb-4">Minhas Ordens de Servi√ßo</h2><div id="os-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div><div class="mt-12"><h2 class="text-2xl font-semibold mb-4">Meus Laudos T√©cnicos</h2><div id="laudos-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>`;
        }

        function getAdminDashboardHTML() {
            return `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="glass-card p-6 rounded-2xl"><h3 class="text-lg text-white/70">O.S. em Aberto</h3><p id="os-aberto-count" class="text-4xl font-bold">0</p></div><div class="glass-card p-6 rounded-2xl"><h3 class="text-lg text-white/70">Total de O.S.</h3><p id="os-total-count" class="text-4xl font-bold">0</p></div><div class="glass-card p-6 rounded-2xl"><h3 class="text-lg text-white/70">Total de Laudos</h3><p id="laudos-total-count" class="text-4xl font-bold">0</p></div></div>
            
            <div class="mb-8">
                <div class="flex border-b border-white/20">
                    <button id="admin-tab-abertas" class="tab-button flex-1 py-3 font-semibold border-b-2 transition-colors duration-300">Abertas</button>
                    <button id="admin-tab-fechadas" class="tab-button flex-1 py-3 font-semibold border-b-2 border-transparent text-white/60 transition-colors duration-300">Fechadas</button>
                </div>
            </div>

            <div id="admin-content-abertas">
                <div class="glass-card p-6 rounded-2xl mb-8"><h2 class="text-2xl font-semibold mb-4">Ordens de Servi√ßo Abertas</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-white/20"><tr><th class="p-3">N¬∫ O.S.</th><th class="p-3">Cliente</th><th class="p-3">Status</th><th class="p-3">Criado por</th><th class="p-3">Data</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="admin-os-list-abertas"></tbody></table></div></div>
                <div class="glass-card p-6 rounded-2xl"><h2 class="text-2xl font-semibold mb-4">Laudos T√©cnicos (N√£o Vinculados a O.S. Fechada)</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-white/20"><th class="p-3">Marca/Modelo</th><th class="p-3">N¬∫ S√©rie</th><th class="p-3">Criado por</th><th class="p-3">Data</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="admin-laudos-list-abertos"></tbody></table></div></div>
            </div>
            
            <div id="admin-content-fechadas" class="hidden">
                 <div class="glass-card p-6 rounded-2xl mb-8"><h2 class="text-2xl font-semibold mb-4">Ordens de Servi√ßo Fechadas</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-white/20"><tr><th class="p-3">N¬∫ O.S.</th><th class="p-3">Cliente</th><th class="p-3">Status</th><th class="p-3">Criado por</th><th class="p-3">Data</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="admin-os-list-fechadas"></tbody></table></div></div>
                 <div class="glass-card p-6 rounded-2xl"><h2 class="text-2xl font-semibold mb-4">Laudos T√©cnicos (Vinculados a O.S. Fechada)</h2><div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b border-white/20"><th class="p-3">Marca/Modelo</th><th class="p-3">N¬∫ S√©rie</th><th class="p-3">Criado por</th><th class="p-3">Data</th><th class="p-3 text-right">A√ß√µes</th></tr></thead><tbody id="admin-laudos-list-fechados"></tbody></table></div></div>
            </div>

            <div class="glass-card p-6 rounded-2xl mt-8 border border-red-500/50"><h2 class="text-2xl font-semibold mb-4 text-red-400">Zona de Perigo</h2><p class="text-white/70 mb-4">Aten√ß√£o: As a√ß√µes abaixo s√£o irrevers√≠veis.</p><div class="flex flex-wrap gap-4"><button onclick="deleteAllFromCollection('serviceOrders')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition">Apagar TODAS as Ordens de Servi√ßo</button><button onclick="deleteAllFromCollection('laudos')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition">Apagar TODOS os Laudos</button></div></div>`;
        }
        
        function getOsFormHTML(isEditing) {
             return `<div class="glass-card max-w-4xl mx-auto p-8 rounded-2xl shadow-2xl"><header class="flex justify-between items-center mb-8"><h1 id="os-form-title" class="text-3xl font-bold">${isEditing ? 'Detalhes da O.S.' : 'Cadastrar Ordem de Servi√ßo'}</h1><button id="form-back-button" class="text-indigo-300 hover:text-indigo-200">&larr; Voltar</button></header><form id="os-form" class="space-y-6"><input type="hidden" id="os-id"><fieldset class="border border-white/20 p-4 rounded-xl"><legend class="text-xl font-semibold px-2">Dados Gerais</legend><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><input type="text" id="os-cliente" placeholder="Cliente" class="glass-input w-full p-3 rounded-xl" required><input type="text" id="os-numero-os" placeholder="N√∫mero da O.S." class="glass-input w-full p-3 rounded-xl" required><input type="text" id="os-tag" placeholder="TAG/Equipamento" class="glass-input w-full p-3 rounded-xl"><input type="text" id="os-motivo" placeholder="Motivo" class="glass-input w-full p-3 rounded-xl" required><select id="os-tipo-servico" class="glass-select w-full p-3 rounded-xl" required><option>Corretiva</option><option>Planejada</option><option>Melhoria</option><option>Predial</option></select><div><label class="block mb-2 text-white/70">M√°quina Parou?</label><div class="flex gap-4 mt-2"><label><input type="radio" name="maquina-parou" value="true" required> Sim</label><label><input type="radio" name="maquina-parou" value="false" checked> N√£o</label></div></div></div></fieldset>
             <fieldset class="border border-white/20 p-4 rounded-xl"><legend class="text-xl font-semibold px-2">Colaboradores</legend>
                <div class="flex gap-2">
                    <select id="users-dropdown" class="glass-select w-full p-3 rounded-xl"></select>
                    <button type="button" onclick="addCollaborator()" class="bg-indigo-500 hover:bg-indigo-600 font-bold py-3 px-4 rounded-xl transition">Adicionar</button>
                </div>
                <div id="collaborators-list" class="mt-4 space-y-2"></div>
             </fieldset>
             <fieldset class="border border-white/20 p-4 rounded-xl"><legend class="text-xl font-semibold px-2">Vincular Laudo</legend>
                <div id="laudo-link-container">
                    <label for="os-linked-laudo" class="block mb-2 text-white/70">Selecione um laudo existente (opcional)</label>
                    <select id="os-linked-laudo" class="glass-select w-full p-3 rounded-xl"></select>
                </div>
             </fieldset>
             <fieldset class="border border-white/20 p-4 rounded-xl"><legend class="text-xl font-semibold px-2">Detalhes do Servi√ßo</legend><div class="space-y-4"><textarea id="os-causa" rows="3" placeholder="Causa Prov√°vel" class="glass-input w-full p-3 rounded-xl"></textarea><textarea id="os-descricao-servico" rows="5" placeholder="Descri√ß√£o do Servi√ßo Realizado" class="glass-input w-full p-3 rounded-xl" required></textarea><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block mb-1 text-white/70">In√≠cio</label><input type="datetime-local" id="os-inicio-ocorrencia" class="glass-input w-full p-3 rounded-xl" required></div><div><label class="block mb-1 text-white/70">Fim</label><input type="datetime-local" id="os-fim-ocorrencia" class="glass-input w-full p-3 rounded-xl" required></div></div></div></fieldset><fieldset class="border border-white/20 p-4 rounded-xl"><legend class="text-xl font-semibold px-2">Pe√ßas Utilizadas</legend><div id="pecas-container" class="space-y-4"></div><button type="button" onclick="addPecaField()" class="mt-4 bg-white/10 hover:bg-white/20 font-bold py-2 px-4 rounded-xl">+ Adicionar Pe√ßa</button></fieldset><fieldset class="border border-white/20 p-4 rounded-xl"><legend class="text-xl font-semibold px-2">M√£o de Obra</legend><div id="mao-de-obra-container" class="space-y-4"></div><button type="button" onclick="addFuncionarioField()" class="mt-4 bg-white/10 hover:bg-white/20 font-bold py-2 px-4 rounded-xl">+ Adicionar Funcion√°rio</button></fieldset><div id="os-form-buttons" class="flex justify-end"><button type="submit" class="bg-blue-500 hover:bg-blue-600 font-bold py-3 px-8 rounded-xl transition">${isEditing ? 'Atualizar O.S.' : 'Salvar O.S.'}</button></div></form></div>`;
        }

        function getLaudoFormHTML(isEditing) {
            return `<div class="glass-card max-w-2xl mx-auto p-8 rounded-2xl shadow-2xl"><header class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold">${isEditing ? 'Detalhes do Laudo' : 'Cadastrar Laudo T√©cnico'}</h1><button id="form-back-button" class="text-indigo-300 hover:text-indigo-200">&larr; Voltar</button></header><form id="laudo-form" class="space-y-6"><input type="hidden" id="laudo-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><input type="text" id="laudo-numero-serie" placeholder="N√∫mero de S√©rie" class="glass-input w-full py-3 px-4 rounded-xl" required><input type="text" id="laudo-marca" placeholder="Marca" class="glass-input w-full py-3 px-4 rounded-xl" required></div><input type="text" id="laudo-modelo" placeholder="Modelo" class="glass-input w-full py-3 px-4 rounded-xl" required><textarea id="laudo-problema" rows="4" placeholder="Problema Apresentado" class="glass-input w-full py-3 px-4 rounded-xl" required></textarea><textarea id="laudo-solucao" rows="4" placeholder="Solu√ß√£o Aplicada" class="glass-input w-full py-3 px-4 rounded-xl" required></textarea><div id="laudo-form-buttons" class="flex justify-end"><button type="submit" id="submit-laudo-button" class="bg-indigo-500 hover:bg-indigo-600 font-bold py-3 px-8 rounded-xl transition">${isEditing ? 'Atualizar Laudo' : 'Salvar Laudo'}</button></div></form></div>`;
        }
        
        // --- FUN√á√ïES AUXILIARES E DE SETUP ---
        async function getUserName(userId) {
            if (userCache[userId]) return userCache[userId];
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                const userName = userDoc.exists ? userDoc.data().name : 'Usu√°rio Deletado';
                userCache[userId] = userName;
                return userName;
            } catch (error) { console.error("Erro ao buscar nome de usu√°rio:", error); return 'Erro'; }
        }

        async function deleteItem(collection, docId) {
            const confirmed = await showModal(`Tem certeza que deseja excluir este item permanentemente? Esta a√ß√£o n√£o pode ser desfeita.`, 'Confirmar Exclus√£o', { isConfirm: true });
            if (confirmed) {
                db.collection(collection).doc(docId).delete()
                  .then(() => showToast('Item exclu√≠do com sucesso.', 'success'))
                  .catch(e => showModal(`Erro ao excluir: ${e.message}`, 'Erro'));
            }
        }

        async function editOsStatus(docId, currentStatus) {
            const newStatus = currentStatus === 'aberto' ? 'fechado' : 'aberto';
            const confirmed = await showModal(`Deseja alterar o status desta O.S. para "${newStatus}"?`, 'Alterar Status', { isConfirm: true });
            if (confirmed) {
                 db.collection('serviceOrders').doc(docId).update({ status: newStatus })
                   .catch(e => showModal(`Erro ao alterar status: ${e.message}`, 'Erro'));
            }
        }

        function switchAuthTab(tab) {
            const loginTabButton = document.getElementById('login-tab-button');
            const registerTabButton = document.getElementById('register-tab-button');
            const loginTabContent = document.getElementById('login-tab-content');
            const registerTabContent = document.getElementById('register-tab-content');
            if (tab === 'login') {
                loginTabButton.classList.add('active');
                registerTabButton.classList.remove('active', 'text-white/60');
                loginTabContent.style.display = 'block';
                registerTabContent.style.display = 'none';
            } else {
                registerTabButton.classList.add('active');
                loginTabButton.classList.remove('active');
                registerTabContent.style.display = 'block';
                loginTabContent.style.display = 'none';
            }
        }

        function setupAuthListeners() {
            document.getElementById('login-tab-button').addEventListener('click', () => switchAuthTab('login'));
            document.getElementById('register-tab-button').addEventListener('click', () => switchAuthTab('register'));
            const loginForm = document.getElementById('login-form');
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                btn.disabled = true; btn.textContent = 'Entrando...';
                auth.signInWithEmailAndPassword(loginForm['login-email'].value, loginForm['login-password'].value)
                .catch(error => {
                    showModal("Erro: " + error.message, 'Erro de Login');
                    btn.disabled = false; btn.textContent = 'Entrar';
                });
            });
            const registerForm = document.getElementById('register-form');
            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                btn.disabled = true; btn.textContent = 'Cadastrando...';
                auth.createUserWithEmailAndPassword(registerForm['register-email'].value, registerForm['register-password'].value)
                .then(cred => db.collection('users').doc(cred.user.uid).set({ name: registerForm['register-name'].value, email: cred.user.email, role: 'student' }))
                .then(() => {
                    showModal("Cadastro realizado com sucesso! Por favor, fa√ßa o login.", "Sucesso");
                    switchAuthTab('login');
                    registerForm.reset();
                })
                .catch(error => showModal("Erro: " + error.message, 'Erro de Cadastro'))
                .finally(() => { btn.disabled = false; btn.textContent = 'Cadastrar'; });
            });
            switchAuthTab('login');
        }

        function renderView(viewId, data = null) {
            currentUnsubscribes.forEach(unsub => unsub());
            currentUnsubscribes = [];
            const appMainView = document.getElementById('app-main-view');
            appMainView.innerHTML = '';
            
            const dataId = (typeof data === 'object' && data !== null) ? data.id : data;
            const context = (typeof data === 'object' && data !== null) ? data.context : null;

            switch(viewId) {
                case 'dashboard-page':
                    appMainView.innerHTML = getDashboardHTML();
                    loadUserData(auth.currentUser.uid);
                    break;
                case 'admin-page':
                    appMainView.innerHTML = getAdminDashboardHTML();
                    loadAdminData();
                    break;
                case 'os-create-page':
                    appMainView.innerHTML = getOsFormHTML(false);
                    setupOsForm();
                    break;
                case 'os-edit-page':
                    appMainView.innerHTML = getOsFormHTML(true);
                    setupOsForm(dataId);
                    break;
                case 'os-user-view':
                case 'os-admin-view':
                    appMainView.innerHTML = getOsFormHTML(true);
                    setupOsForm(dataId, true);
                    break;
                case 'laudo-create-page':
                    appMainView.innerHTML = getLaudoFormHTML(false);
                    setupLaudoForm();
                    break;
                case 'laudo-edit-page':
                    appMainView.innerHTML = getLaudoFormHTML(true);
                    setupLaudoForm(dataId);
                    break;
                case 'laudo-user-view':
                case 'laudo-admin-view':
                    appMainView.innerHTML = getLaudoFormHTML(true);
                    setupLaudoForm(dataId, true, context); // Pass context (like fromOsId)
                    break;
            }
        }

        // --- MASTER RENDER FUNCTIONS ---
        let osData = [], laudosData = [];

        async function renderUserDashboard() {
            const osListEl = document.getElementById('os-list');
            const laudosListEl = document.getElementById('laudos-list');
            if (!osListEl || !laudosListEl) return;

            const closedLaudoIds = new Set();
            osData.forEach(osDoc => {
                const os = osDoc.data();
                if (os.status === 'fechado' && os.linkedLaudoId) {
                    closedLaudoIds.add(os.linkedLaudoId);
                }
            });

            let osHtml = '';
            const sortedOs = osData.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
            if (sortedOs.length === 0) {
                osListEl.innerHTML = '<p class="text-white/50 col-span-full">Nenhuma ordem de servi√ßo encontrada.</p>';
            } else {
                for (const doc of sortedOs) {
                    const os = doc.data();
                    const createdDate = os.createdAt ? os.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data indispon√≠vel';
                    let permissionButtonHTML = '';
                    if (os.editRequest === 'pending') { permissionButtonHTML = `<button disabled class="flex-1 bg-yellow-500/50 text-white font-bold py-2 px-4 rounded-xl transition">Pendente</button>`;
                    } else if (os.editRequest === 'denied') { permissionButtonHTML = `<button onclick="requestPermission('serviceOrders', '${doc.id}')" class="flex-1 bg-red-500/80 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-xl transition">Solicitar Novamente</button>`;
                    } else if (os.editRequest === 'approved') { permissionButtonHTML = `<button onclick="renderView('os-edit-page', '${doc.id}')" class="flex-1 bg-green-500/80 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-xl transition">Editar</button>`;
                    } else { permissionButtonHTML = `<button onclick="requestPermission('serviceOrders', '${doc.id}')" class="flex-1 bg-gray-500/80 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-xl transition">Permiss√£o</button>`; }
                    
                    const isClosed = os.status === 'fechado';
                    const isCollaborator = os.userId !== auth.currentUser.uid;
                    const creatorName = await getUserName(os.userId);

                    osHtml += `<div class="glass-card text-left p-6 rounded-2xl flex flex-col justify-between ${isClosed ? 'border-green-500' : ''}">
                                <div>
                                    <h3 class="font-bold text-xl mb-2 text-blue-300 flex justify-between items-center"><span>O.S. #${os.numeroOS}</span>${isClosed ? '<span class="px-2 py-1 rounded-full text-xs font-bold bg-green-500 text-white">Fechado</span>' : ''}</h3>
                                    <p><span class="font-semibold text-white/70">Cliente:</span> ${os.cliente}</p>
                                    ${isCollaborator ? `<p class="text-sm text-indigo-300"><span class="font-semibold">Compartilhado por:</span> ${creatorName}</p>` : ''}
                                    <p class="text-sm mt-2 text-white/50">Criado em: ${createdDate}</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button onclick="renderView('os-user-view', '${doc.id}')" class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-2 px-4 rounded-xl transition">Ver Detalhes</button>
                                    ${permissionButtonHTML}
                                </div>
                             </div>`;
                };
                osListEl.innerHTML = osHtml;
            }

            let laudosHtml = '';
            const sortedLaudos = laudosData.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
            if (sortedLaudos.length === 0) {
                laudosListEl.innerHTML = '<p class="text-white/50 col-span-full">Nenhum laudo t√©cnico encontrado.</p>';
            } else {
                 for (const doc of sortedLaudos) {
                    const laudo = doc.data();
                    const createdDate = laudo.createdAt ? laudo.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data indispon√≠vel';
                    let permissionButtonHTML = '';
                    if (laudo.editRequest === 'pending') { permissionButtonHTML = `<button disabled class="flex-1 bg-yellow-500/50 text-white font-bold py-2 px-4 rounded-xl transition">Pendente</button>`;
                    } else if (laudo.editRequest === 'denied') { permissionButtonHTML = `<button onclick="requestPermission('laudos', '${doc.id}')" class="flex-1 bg-red-500/80 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-xl transition">Solicitar Novamente</button>`;
                    } else if (laudo.editRequest === 'approved') { permissionButtonHTML = `<button onclick="renderView('laudo-edit-page', '${doc.id}')" class="flex-1 bg-green-500/80 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-xl transition">Editar</button>`;
                    } else { permissionButtonHTML = `<button onclick="requestPermission('laudos', '${doc.id}')" class="flex-1 bg-gray-500/80 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-xl transition">Permiss√£o</button>`; }
                    
                    const isCollaborator = laudo.userId !== auth.currentUser.uid;
                    const creatorName = await getUserName(laudo.userId);
                    const isLinkedToClosedOs = closedLaudoIds.has(doc.id);

                    laudosHtml += `<div class="glass-card p-6 rounded-2xl flex flex-col justify-between ${isLinkedToClosedOs ? 'border-green-500' : ''}">
                                <div>
                                    <h3 class="font-bold text-xl mb-2 text-indigo-300">Laudo: ${laudo.marca} ${laudo.modelo}</h3>
                                    <p><span class="font-semibold text-white/70">N¬∫ S√©rie:</span> ${laudo.numeroSerie}</p>
                                    ${isCollaborator ? `<p class="text-sm text-indigo-300"><span class="font-semibold">Compartilhado por:</span> ${creatorName}</p>` : ''}
                                    <p class="text-sm mt-2 text-white/50">Criado em: ${createdDate}</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button onclick="renderView('laudo-user-view', '${doc.id}')" class="flex-1 bg-white/10 hover:bg-white/20 text-white font-bold py-2 px-4 rounded-xl transition">Ver Detalhes</button>
                                    ${permissionButtonHTML}
                                </div>
                             </div>`;
                };
                laudosListEl.innerHTML = laudosHtml;
            }
        }

        async function renderAdminDashboard() {
            const adminOsListAbertas = document.getElementById('admin-os-list-abertas');
            const adminLaudosListAbertos = document.getElementById('admin-laudos-list-abertos');
            const adminOsListFechadas = document.getElementById('admin-os-list-fechadas');
            const adminLaudosListFechados = document.getElementById('admin-laudos-list-fechados');

            if (!adminOsListAbertas) return;

            let osHtmlAbertas = '', osHtmlFechadas = '';
            const closedOsLinkedLaudoIds = new Set();

            for (const doc of osData) {
                const os = doc.data();
                const userName = await getUserName(os.userId);
                const createdDate = os.createdAt ? os.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data indispon√≠vel';
                let requestIndicator = '';
                let actions = `<button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editOsStatus('${doc.id}', '${os.status}')">Status</button><button class="text-red-400 hover:text-red-300" onclick="deleteItem('serviceOrders', '${doc.id}')">Excluir</button>`;
                if (os.editRequest === 'pending') {
                    requestIndicator = '<span class="text-yellow-400 ml-2 font-semibold">(Solicita√ß√£o Pendente)</span>';
                    actions = `<button class="text-green-400 hover:text-green-300 mr-2" onclick="managePermission('serviceOrders', '${doc.id}', 'approved')">Aprovar</button><button class="text-red-500 hover:text-red-400 mr-2" onclick="managePermission('serviceOrders', '${doc.id}', 'denied')">Negar</button>` + actions;
                }
                const rowHtml = `<tr class="border-b border-white/10 hover:bg-white/5"><td class="p-3 cursor-pointer" onclick="renderView('os-admin-view', '${doc.id}')">${os.numeroOS}</td><td class="p-3 cursor-pointer" onclick="renderView('os-admin-view', '${doc.id}')">${os.cliente}${requestIndicator}</td><td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${os.status === 'aberto' ? 'bg-yellow-500 text-black' : 'bg-green-500 text-white'}">${os.status}</span></td><td class="p-3">${userName}</td><td class="p-3">${createdDate}</td><td class="p-3 text-right">${actions}</td></tr>`;

                if (os.status === 'fechado') {
                    osHtmlFechadas += rowHtml;
                    if (os.linkedLaudoId) closedOsLinkedLaudoIds.add(os.linkedLaudoId);
                } else { osHtmlAbertas += rowHtml; }
            }
            adminOsListAbertas.innerHTML = osHtmlAbertas || '<tr><td colspan="6" class="p-4 text-center text-white/50">Nenhuma O.S. aberta encontrada.</td></tr>';
            adminOsListFechadas.innerHTML = osHtmlFechadas || '<tr><td colspan="6" class="p-4 text-center text-white/50">Nenhuma O.S. fechada encontrada.</td></tr>';

            let laudosHtmlAbertos = '', laudosHtmlFechados = '';
            for (const doc of laudosData) {
                const laudo = doc.data();
                const userName = await getUserName(laudo.userId);
                const createdDate = laudo.createdAt ? laudo.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data indispon√≠vel';
                let requestIndicator = '';
                let actions = `<button class="text-red-400 hover:text-red-300" onclick="event.stopPropagation(); deleteItem('laudos', '${doc.id}')">Excluir</button>`;
                if (laudo.editRequest === 'pending') {
                    requestIndicator = '<span class="text-yellow-400 ml-2 font-semibold">(Solicita√ß√£o Pendente)</span>';
                    actions = `<button class="text-green-400 hover:text-green-300 mr-2" onclick="managePermission('laudos', '${doc.id}', 'approved')">Aprovar</button><button class="text-red-500 hover:text-red-400 mr-2" onclick="managePermission('laudos', '${doc.id}', 'denied')">Negar</button>` + actions;
                }
                const rowHtml = `<tr class="border-b border-white/10 hover:bg-white/5 cursor-pointer" onclick="renderView('laudo-admin-view', '${doc.id}')"><td class="p-3">${laudo.marca} ${laudo.modelo}${requestIndicator}</td><td class="p-3">${laudo.numeroSerie}</td><td class="p-3">${userName}</td><td class="p-3">${createdDate}</td><td class="p-3 text-right">${actions}</td></tr>`;

                if (closedOsLinkedLaudoIds.has(doc.id)) { laudosHtmlFechados += rowHtml;
                } else { laudosHtmlAbertos += rowHtml; }
            }
            adminLaudosListAbertos.innerHTML = laudosHtmlAbertos || '<tr><td colspan="5" class="p-4 text-center text-white/50">Nenhum Laudo encontrado.</td></tr>';
            adminLaudosListFechados.innerHTML = laudosHtmlFechados || '<tr><td colspan="5" class="p-4 text-center text-white/50">Nenhum Laudo vinculado a O.S. fechada.</td></tr>';
        }

        // --- DATA LOADING FUNCTIONS ---
        function loadUserData(userId) {
            const unsubOs = db.collection('serviceOrders').where('memberIds', 'array-contains', userId).onSnapshot(snapshot => {
                osData = snapshot.docs;
                renderUserDashboard();
            }, error => { console.error("Erro ao carregar Ordens de Servi√ßo: ", error); });
            currentUnsubscribes.push(unsubOs);
            
            const unsubLaudos = db.collection('laudos').where('memberIds', 'array-contains', userId).onSnapshot(snapshot => {
                laudosData = snapshot.docs;
                renderUserDashboard();
            }, error => { console.error("Erro ao carregar Laudos: ", error); });
            currentUnsubscribes.push(unsubLaudos);
        }

        function loadAdminData() {
            document.getElementById('admin-tab-abertas').addEventListener('click', () => switchAdminTab('abertas'));
            document.getElementById('admin-tab-fechadas').addEventListener('click', () => switchAdminTab('fechadas'));
            switchAdminTab('abertas'); // Default tab

            const unsubOs = db.collection('serviceOrders').onSnapshot(async (snapshot) => {
                document.getElementById('os-total-count').textContent = snapshot.size;
                document.getElementById('os-aberto-count').textContent = snapshot.docs.filter(d => d.data().status === 'aberto').length;
                osData = snapshot.docs;
                await renderAdminDashboard();
            }, error => { console.error("Erro no listener de O.S. do Admin: ", error); });
            currentUnsubscribes.push(unsubOs);
            
            const unsubLaudos = db.collection('laudos').onSnapshot(async (snapshot) => {
                document.getElementById('laudos-total-count').textContent = snapshot.size;
                laudosData = snapshot.docs;
                await renderAdminDashboard();
            }, error => { console.error("Erro no listener de Laudos do Admin: ", error); });
            currentUnsubscribes.push(unsubLaudos);
        }

        function switchAdminTab(tab) {
            const abertasTab = document.getElementById('admin-tab-abertas');
            const fechadasTab = document.getElementById('admin-tab-fechadas');
            const abertasContent = document.getElementById('admin-content-abertas');
            const fechadasContent = document.getElementById('admin-content-fechadas');

            if (tab === 'abertas') {
                abertasTab.classList.add('active');
                fechadasTab.classList.remove('active');
                abertasContent.classList.remove('hidden');
                fechadasContent.classList.add('hidden');
            } else {
                fechadasTab.classList.add('active');
                abertasTab.classList.remove('active');
                fechadasContent.classList.remove('hidden');
                abertasContent.classList.add('hidden');
            }
        }
        
        async function setupLaudoForm(laudoId = null, isReadOnly = false, fromOsId = null) {
            const laudoForm = document.getElementById('laudo-form');
            const backButton = document.getElementById('form-back-button');
            
            if (fromOsId) {
                backButton.onclick = () => renderView('os-admin-view', fromOsId);
            } else {
                backButton.onclick = () => goHome();
            }

            const isEditing = laudoId !== null;

            if(isEditing) {
                const docRef = db.collection('laudos').doc(laudoId);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    laudoForm.querySelector('#laudo-id').value = laudoId;
                    laudoForm.querySelector('#laudo-numero-serie').value = data.numeroSerie || '';
                    laudoForm.querySelector('#laudo-marca').value = data.marca || '';
                    laudoForm.querySelector('#laudo-modelo').value = data.modelo || '';
                    laudoForm.querySelector('#laudo-problema').value = data.problemaApresentado || '';
                    laudoForm.querySelector('#laudo-solucao').value = data.solucao || '';

                    if (isReadOnly) {
                        laudoForm.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
                        laudoForm.querySelector('#laudo-form-buttons').style.display = 'none';
                        return;
                    }

                    const user = auth.currentUser;
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userIsAdmin = userDoc.exists && userDoc.data().role === 'admin';

                    if (!userIsAdmin && data.editRequest !== 'approved') {
                        laudoForm.querySelectorAll('input, textarea').forEach(el => el.disabled = true);
                        laudoForm.querySelector('#laudo-form-buttons').innerHTML = `<p class="text-yellow-400 text-right font-semibold">Aguardando aprova√ß√£o do administrador para editar.</p>`;
                    }
                }
            }
            
            laudoForm.addEventListener('submit', handleLaudoFormSubmit);
        }

        function handleLaudoFormSubmit(e) {
            e.preventDefault();
            const submitButton = document.getElementById('submit-laudo-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Salvando...';

            const user = auth.currentUser;
            const laudoId = document.getElementById('laudo-id').value;
            const isEditing = laudoId !== '';

            const data = {
                numeroSerie: document.getElementById('laudo-numero-serie').value,
                marca: document.getElementById('laudo-marca').value,
                modelo: document.getElementById('laudo-modelo').value,
                problemaApresentado: document.getElementById('laudo-problema').value,
                solucao: document.getElementById('laudo-solucao').value,
            };

            const promise = isEditing
                ? db.collection('laudos').doc(laudoId).update({ ...data, editRequest: 'used' })
                : db.collection('laudos').add({ ...data, userId: user.uid, memberIds: [user.uid], createdAt: firebase.firestore.FieldValue.serverTimestamp() });

            promise.then(() => {
                showToast(`Laudo ${isEditing ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                goHome();
            }).catch(error => {
                showModal("Erro ao salvar o laudo: " + error.message, 'Erro');
            }).finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = isEditing ? 'Atualizar Laudo' : 'Salvar Laudo';
            });
        }

        async function setupOsForm(osId = null, isReadOnly = false) {
            const osForm = document.getElementById('os-form');
            document.getElementById('form-back-button').onclick = () => goHome();
            const isEditing = osId !== null;

            await populateUsersDropdown();

            if (isEditing) {
                const docRef = db.collection('serviceOrders').doc(osId);
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    await populateLaudosDropdown(data.linkedLaudoId);
                    osForm.querySelector('#os-id').value = osId;
                    osForm.querySelector('#os-cliente').value = data.cliente || '';
                    osForm.querySelector('#os-numero-os').value = data.numeroOS || '';
                    osForm.querySelector('#os-tag').value = data.tag || '';
                    osForm.querySelector('#os-motivo').value = data.motivo || '';
                    osForm.querySelector('#os-tipo-servico').value = data.tipoServico || 'Corretiva';
                    if (data.maquinaParou !== undefined) { osForm.querySelector(`input[name="maquina-parou"][value="${data.maquinaParou}"]`).checked = true; }
                    osForm.querySelector('#os-causa').value = data.causa || '';
                    osForm.querySelector('#os-descricao-servico').value = data.descricaoServico || '';
                    if (data.inicioOcorrencia?.toDate) { osForm.querySelector('#os-inicio-ocorrencia').value = new Date(data.inicioOcorrencia.toDate().getTime() - (data.inicioOcorrencia.toDate().getTimezoneOffset() * 60000)).toISOString().slice(0, 16); }
                    if (data.fimOcorrencia?.toDate) { osForm.querySelector('#os-fim-ocorrencia').value = new Date(data.fimOcorrencia.toDate().getTime() - (data.fimOcorrencia.toDate().getTimezoneOffset() * 60000)).toISOString().slice(0, 16); }
                    osForm.querySelector('#pecas-container').innerHTML = '';
                    (data.pecas || []).forEach(peca => addPecaField(peca));
                    osForm.querySelector('#mao-de-obra-container').innerHTML = '';
                    (data.maoDeObra || []).forEach(func => addFuncionarioField(func));
                    
                    document.getElementById('collaborators-list').innerHTML = '';
                    (data.collaborators || []).forEach(c => renderCollaborator(c));


                    if (isReadOnly) {
                        osForm.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
                        osForm.querySelector('#os-form-buttons').style.display = 'none';
                        osForm.querySelectorAll('button[type="button"]').forEach(btn => btn.style.display = 'none');

                        const laudoLinkContainer = document.getElementById('laudo-link-container');
                        const linkedLaudoId = data.linkedLaudoId;
                        if (linkedLaudoId) {
                            const laudoSelect = document.getElementById('os-linked-laudo');
                            const selectedOption = laudoSelect.querySelector(`option[value="${linkedLaudoId}"]`);
                            const laudoText = selectedOption ? selectedOption.textContent : 'Laudo Vinculado';

                            laudoLinkContainer.innerHTML = `
                                <label class="block mb-2 text-white/70">Laudo Vinculado</label>
                                <button type="button" id="laudo-nav-button"
                                        class="glass-input text-left w-full p-3 rounded-xl hover:border-indigo-400 border border-transparent transition flex justify-between items-center">
                                    <span>${laudoText}</span>
                                    <span class="text-indigo-300 font-bold">&rarr;</span>
                                </button>
                            `;
                            document.getElementById('laudo-nav-button').onclick = () => {
                                renderView('laudo-admin-view', { id: linkedLaudoId, context: osId });
                            };
                        } else {
                            laudoLinkContainer.innerHTML = `
                                <label class="block mb-2 text-white/70">Laudo Vinculado</label>
                                <p class="glass-input w-full p-3 rounded-xl opacity-60">Nenhum laudo vinculado</p>
                            `;
                        }
                        return;
                    }

                    const user = auth.currentUser;
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    const userIsAdmin = userDoc.exists && userDoc.data().role === 'admin';

                    if (!userIsAdmin && data.editRequest !== 'approved') {
                        osForm.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true);
                        osForm.querySelectorAll('button[type="button"]').forEach(btn => btn.style.display = 'none');
                        osForm.querySelector('#os-form-buttons').innerHTML = `<p class="text-yellow-400 text-right font-semibold">Aguardando aprova√ß√£o do administrador para editar.</p>`;
                    }
                }
            } else {
                await populateLaudosDropdown();
                addPecaField();
                addFuncionarioField();
            }
            osForm.addEventListener('submit', handleOsFormSubmit);
        }
        
        async function handleOsFormSubmit(e) {
            e.preventDefault();
            const osForm = document.getElementById('os-form');
            const submitButton = osForm.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            const originalButtonText = submitButton.textContent;
            submitButton.textContent = 'Salvando...';

            const user = auth.currentUser;
            const osId = document.getElementById('os-id').value;
            const isEditing = osId !== '';

            const collaborators = Array.from(document.querySelectorAll('.collaborator-item')).map(el => ({
                id: el.dataset.id,
                name: el.dataset.name
            }));
            const memberIds = [user.uid, ...collaborators.map(c => c.id)];

            const data = {
                userId: user.uid,
                memberIds: memberIds,
                collaborators: collaborators,
                cliente: document.getElementById('os-cliente').value,
                numeroOS: document.getElementById('os-numero-os').value,
                tag: document.getElementById('os-tag').value,
                motivo: document.getElementById('os-motivo').value,
                tipoServico: document.getElementById('os-tipo-servico').value,
                maquinaParou: document.querySelector('input[name="maquina-parou"]:checked').value === 'true',
                causa: document.getElementById('os-causa').value,
                descricaoServico: document.getElementById('os-descricao-servico').value,
                inicioOcorrencia: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('os-inicio-ocorrencia').value)),
                fimOcorrencia: firebase.firestore.Timestamp.fromDate(new Date(document.getElementById('os-fim-ocorrencia').value)),
                linkedLaudoId: document.getElementById('os-linked-laudo').value,
                pecas: Array.from(document.querySelectorAll('.peca-item')).map(div => ({ codigo: div.querySelector('[name=peca-codigo]').value, descricao: div.querySelector('[name=peca-descricao]').value, quantidade: Number(div.querySelector('[name=peca-quantidade]').value) })).filter(p => p.descricao && p.quantidade > 0),
                maoDeObra: Array.from(document.querySelectorAll('.funcionario-item')).map(div => ({ nome: div.querySelector('[name=funcionario-nome]').value })).filter(f => f.nome),
            };

            const osPromise = isEditing 
                ? db.collection('serviceOrders').doc(osId).update({...data, editRequest: 'used'})
                : db.collection('serviceOrders').add({ ...data, status: 'aberto', createdAt: firebase.firestore.FieldValue.serverTimestamp() });

            osPromise.then(async (docRef) => {
                const finalOsId = isEditing ? osId : docRef.id;
                if (data.linkedLaudoId) {
                    await db.collection('laudos').doc(data.linkedLaudoId).update({ memberIds: memberIds });
                }
                showToast(`Ordem de Servi√ßo ${isEditing ? 'atualizada' : 'salva'}!`, 'success');
                goHome();
            }).catch(error => {
                showModal("Erro ao salvar a O.S.: " + error.message, 'Erro');
            }).finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = originalButtonText;
            });
        }

        async function populateLaudosDropdown(selectedId = null) {
            const select = document.getElementById('os-linked-laudo');
            if (!select) return;
            select.innerHTML = '<option value="">Nenhum</option>';
            const user = auth.currentUser;
            if (!user) return;
            try {
                // Query for laudos where the current user is a member
                const laudosSnapshot = await db.collection('laudos').where('memberIds', 'array-contains', user.uid).get();
                const sortedDocs = laudosSnapshot.docs.sort((a, b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));
                sortedDocs.forEach(doc => {
                    const laudo = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `Laudo: ${laudo.marca} ${laudo.modelo} (S/N: ${laudo.numeroSerie})`;
                    if (doc.id === selectedId) option.selected = true;
                    select.appendChild(option);
                });
            } catch (error) { 
                console.error("Erro ao popular dropdown de laudos:", error); 
            }
        }

        async function populateUsersDropdown() {
            const select = document.getElementById('users-dropdown');
            if(!select) return;
            select.innerHTML = '<option value="">Selecione um usu√°rio</option>';
            const usersSnapshot = await db.collection('users').get();
            usersSnapshot.forEach(doc => {
                if (doc.id === auth.currentUser.uid) return; // Skip current user
                const user = doc.data();
                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = `${user.name} (${user.email})`;
                select.appendChild(option);
            });
        }

        function addCollaborator() {
            const select = document.getElementById('users-dropdown');
            const userId = select.value;
            if (!userId) return;

            const collaboratorsList = document.getElementById('collaborators-list');
            const existing = collaboratorsList.querySelector(`[data-id="${userId}"]`);
            if (existing) {
                showToast('Este usu√°rio j√° foi adicionado.', 'error');
                return;
            }

            const userName = select.options[select.selectedIndex].text;
            renderCollaborator({ id: userId, name: userName });
            select.value = ''; // Reset dropdown
        }

        function renderCollaborator(collaborator) {
            const collaboratorsList = document.getElementById('collaborators-list');
            const div = document.createElement('div');
            div.className = 'collaborator-item flex justify-between items-center bg-white/5 p-2 rounded-lg';
            div.dataset.id = collaborator.id;
            div.dataset.name = collaborator.name;
            div.innerHTML = `<span>${collaborator.name}</span><button type="button" class="text-red-400 hover:text-red-300" onclick="this.parentElement.remove()">&#x2715;</button>`;
            collaboratorsList.appendChild(div);
        }

        function addPecaField(data = { codigo: '', descricao: '', quantidade: '' }) {
            const container = document.getElementById('pecas-container');
            if(!container) return;
            const div = document.createElement('div');
            div.className = 'peca-item grid grid-cols-1 md:grid-cols-7 gap-2 items-center';
            div.innerHTML = `<input type="text" name="peca-codigo" placeholder="C√≥digo" class="glass-input p-2 rounded-lg md:col-span-2" value="${data.codigo}"><input type="text" name="peca-descricao" placeholder="Descri√ß√£o da Pe√ßa" class="glass-input p-2 rounded-lg md:col-span-3" value="${data.descricao}"><input type="number" name="peca-quantidade" placeholder="Qtd." class="glass-input p-2 rounded-lg md:col-span-1" min="1" value="${data.quantidade}"><button type="button" class="bg-red-500/50 hover:bg-red-500 p-2 rounded-lg md:col-span-1" onclick="this.parentElement.remove()">X</button>`;
            container.appendChild(div);
        }

        function addFuncionarioField(data = { nome: '' }) {
            const container = document.getElementById('mao-de-obra-container');
            if(!container) return;
            const div = document.createElement('div');
            div.className = 'funcionario-item grid grid-cols-1 md:grid-cols-5 gap-2 items-center';
            div.innerHTML = `<input type="text" name="funcionario-nome" placeholder="Nome do Funcion√°rio" class="glass-input p-2 rounded-lg md:col-span-4" value="${data.nome}"><button type="button" class="bg-red-500/50 hover:bg-red-500 p-2 rounded-lg md:col-span-1" onclick="this.parentElement.remove()">X</button>`;
            container.appendChild(div);
        }

        // --- FUN√á√ïES DAS NOVAS FUNCIONALIDADES ---
        async function requestPermission(collection, docId) {
            const confirmed = await showModal(`Voc√™ deseja solicitar permiss√£o ao administrador para editar este item?`, 'Solicitar Permiss√£o', { isConfirm: true });
            if (confirmed) {
                db.collection(collection).doc(docId).update({ editRequest: 'pending' })
                  .then(() => showToast("Solicita√ß√£o enviada! O administrador ser√° notificado.", 'info'))
                  .catch(e => showModal("Erro ao enviar solicita√ß√£o: " + e.message, 'Erro'));
            }
        }
        
        async function managePermission(collection, docId, decision) {
            const message = decision === 'approved' ? 'Aprovar a solicita√ß√£o de edi√ß√£o?' : 'Negar a solicita√ß√£o de edi√ß√£o?';
            const confirmed = await showModal(message, 'Gerenciar Permiss√£o', { isConfirm: true });
            if (confirmed) {
                db.collection(collection).doc(docId).update({ editRequest: decision })
                .then(() => showToast(`Permiss√£o ${decision === 'approved' ? 'aprovada' : 'negada'}.`, 'success'))
                .catch(e => showModal("Erro ao processar a permiss√£o: " + e.message, 'Erro'));
            }
        }

        async function deleteAllFromCollection(collectionName) {
            const firstConfirm = await showModal(`Voc√™ est√° prestes a apagar <b>TODOS</b> os documentos da cole√ß√£o "<b>${collectionName}</b>".<br><br>Esta a√ß√£o √© irrevers√≠vel.`, 'Confirmar Exclus√£o em Massa', { isConfirm: true });
            if (!firstConfirm) return;

            const secondConfirm = await showModal(`Para confirmar, digite o nome da cole√ß√£o que deseja apagar: "<b>${collectionName}</b>"`, 'Confirma√ß√£o Final', { isConfirm: true, withInput: true });
            if (!secondConfirm.confirmed || secondConfirm.value !== collectionName) {
                showModal("A√ß√£o cancelada. O nome da cole√ß√£o n√£o corresponde.", 'Cancelado');
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                const collectionRef = db.collection(collectionName);
                const snapshot = await collectionRef.get();
                if(snapshot.empty) {
                    showToast(`A cole√ß√£o "${collectionName}" j√° est√° vazia.`, 'info');
                    loadingOverlay.style.display = 'none';
                    return;
                }
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => { batch.delete(doc.ref); });
                
                await batch.commit();
                showModal(`Todos os ${snapshot.size} documentos de "${collectionName}" foram exclu√≠dos com sucesso.`, 'Sucesso');
            } catch (error) {
                showModal(`Ocorreu um erro: ${error.message}`, 'Erro na Exclus√£o');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // --- L√ìGICA DE AUTENTICA√á√ÉO E RENDERIZA√á√ÉO INICIAL ---
        async function goHome() {
            try {
                 const user = auth.currentUser;
                 if (!user) return;
                 const doc = await db.collection('users').doc(user.uid).get();
                 if (doc.exists && doc.data().role === 'admin') {
                     renderView('admin-page');
                 } else {
                     renderView('dashboard-page');
                 }
            } catch (error) {
                console.error("Erro ao navegar para home:", error);
                renderView('dashboard-page'); // Fallback
            }
        }

        auth.onAuthStateChanged(async user => {
            if (user) {
                appRoot.innerHTML = getAppShellHTML();
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('logout-button').addEventListener('click', () => {
                    loadingOverlay.style.display = 'flex';
                    currentUnsubscribes.forEach(unsub => unsub());
                    currentUnsubscribes = [];
                    auth.signOut();
                });

                try {
                    const doc = await db.collection('users').doc(user.uid).get();
                    if (doc.exists && doc.data().role === 'admin') {
                        document.getElementById('admin-button-container').innerHTML = `<button onclick="renderView('admin-page')" class="bg-amber-500/80 hover:bg-amber-500 text-white font-bold py-2 px-4 rounded-xl transition">Admin</button>`;
                        renderView('admin-page');
                    } else {
                        document.getElementById('admin-button-container').innerHTML = '';
                        renderView('dashboard-page');
                    }
                } catch (error) {
                    showModal("Erro ao verificar permiss√µes: " + error.message, 'Erro Cr√≠tico');
                    auth.signOut();
                }
            } else {
                appRoot.innerHTML = getAuthShellHTML();
                setupAuthListeners();
            }
            loadingOverlay.style.display = 'none';
        });
    </script>
</body>
</html>
