<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EProjects - Controle de Manutenção</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.292.0/lucide.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center; z-index: 50;
        }
        .modal-content { max-height: 90vh; }
        .form-section-title {
            font-size: 1.125rem; font-weight: 600; color: #f97316; /* orange-500 */
            border-bottom: 2px solid #374151; /* gray-700 */
            padding-bottom: 0.5rem; margin-bottom: 1rem; margin-top: 1.5rem;
        }
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1f2937 inset !important; /* bg-gray-800 */
            -webkit-text-fill-color: #f3f4f6 !important; /* gray-100 */
        }
        .prose { color: #d1d5db; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .auth-card {
            background-color: #1f2937; /* bg-gray-800 */
            padding: 2rem;
            margin-top: 4rem;
            border-radius: 0.75rem;
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            border: 1px solid #374151; /* gray-700 */
        }
        input:read-only {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
        }
        /* Para garantir que o clique no ícone seja capturado pelo botão pai */
        .status-button i, .edit-user-form-button i, .edit-asset-button i, .delete-asset-button i {
             pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="app" class="container mx-auto p-4 md:p-8">

        <div id="auth-container" class="max-w-md mx-auto">
            <img src="https://i.imgur.com/EDw5HWL.png" alt="Logo da EProjects" class="w-48 mx-auto mb-6">

            <div id="login-screen" class="auth-card">
                <h1 class="text-2xl font-bold text-center text-gray-100 mb-6">Acessar Sistema</h1>
                <form id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="E-mail" required class="w-full px-4 py-3 bg-gray-900 text-gray-100 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="password" id="login-password" placeholder="Senha" required class="w-full px-4 py-3 bg-gray-900 text-gray-100 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <button type="submit" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700 transition duration-300">Entrar</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Não tem uma conta? <button id="show-register" class="font-semibold text-orange-500 hover:underline">Cadastre-se</button>
                </p>
            </div>

            <div id="register-screen" class="auth-card hidden">
                 <h1 class="text-2xl font-bold text-center text-gray-100 mb-6">Criar Conta</h1>
                <form id="register-form" class="space-y-4">
                    <input type="text" id="register-name" placeholder="Nome Completo" required class="w-full px-4 py-3 bg-gray-900 text-gray-100 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="email" id="register-email" placeholder="E-mail" required class="w-full px-4 py-3 bg-gray-900 text-gray-100 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="tel" id="register-phone" placeholder="Número de Celular" required class="w-full px-4 py-3 bg-gray-900 text-gray-100 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" required class="w-full px-4 py-3 bg-gray-900 text-gray-100 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <button type="submit" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700 transition duration-300">Cadastrar</button>
                </form>
                <p class="text-center text-sm text-gray-400 mt-6">
                    Já tem uma conta? <button id="show-login" class="font-semibold text-orange-500 hover:underline">Acesse aqui</button>
                </p>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <header class="flex flex-wrap justify-between items-center mb-8 pb-4 border-b border-gray-700 gap-4">
                <div>
                    <img src="https://i.imgur.com/EDw5HWL.png" alt="Logo da EProjects" class="w-40">
                    <p class="text-gray-400 mt-2">Bem-vindo, <span id="user-name" class="font-semibold text-orange-500"></span>!</p>
                </div>
                 <div>
                    <p class="text-xs text-right text-gray-500">UID: <span id="user-id-display-main" class="font-mono"></span></p>
                    <button id="logout-button" class="flex items-center gap-2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 mt-2">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>Sair</span>
                    </button>
                </div>
            </header>

            <div id="admin-view" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-1">
                        <nav id="admin-nav" class="space-y-2">
                            <button data-target="admin-forms" class="w-full flex items-center gap-3 p-3 rounded-lg bg-orange-600 text-white font-semibold transition duration-200">
                                <i data-lucide="file-text" class="w-5 h-5"></i> <span>Fichas</span>
                            </button>
                            <button data-target="admin-users" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition duration-200">
                                <i data-lucide="users" class="w-5 h-5"></i> <span>Usuários</span>
                            </button>
                            <button data-target="admin-machines" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition duration-200">
                                <i data-lucide="cpu" class="w-5 h-5"></i> <span>Máquinas</span>
                            </button>
                            <button data-target="admin-tools" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition duration-200">
                                <i data-lucide="wrench" class="w-5 h-5"></i> <span>Ferramentas</span>
                            </button>
                            <button data-target="admin-parts" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-700 transition duration-200">
                                <i data-lucide="toy-brick" class="w-5 h-5"></i> <span>Peças</span>
                            </button>
                        </nav>
                    </div>
                    <div class="md:col-span-3 bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
                        <div id="admin-forms" class="admin-tab-content"></div>
                        <div id="admin-users" class="admin-tab-content hidden"></div>
                        <div id="admin-machines" class="admin-tab-content hidden"></div>
                        <div id="admin-tools" class="admin-tab-content hidden"></div>
                        <div id="admin-parts" class="admin-tab-content hidden"></div>
                    </div>
                </div>
            </div>

            <div id="user-view" class="hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-100">Minhas Fichas de Manutenção</h2>
                    <button id="new-form-button" class="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700 flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> <span>Nova Ficha</span></button>
                </div>
                <div id="user-forms-list" class="mb-8 space-y-3"></div>
                <div id="maintenance-form-container" class="hidden bg-gray-800 p-6 md:p-8 rounded-xl shadow-lg border border-gray-700"></div>

                <div id="user-asset-management" class="mt-12">
                    <h2 class="text-2xl font-bold text-gray-100 mb-4">Gerenciamento de Ativos</h2>
                    <div id="user-asset-tabs" class="flex border-b border-gray-700 mb-4"></div>
                    <div id="user-asset-content" class="bg-gray-800 p-6 rounded-b-xl rounded-r-xl shadow-lg border-t-0 border border-gray-700"></div>
                </div>
            </div>
        </div>

        <div id="modal-container"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, onSnapshot, collection, updateDoc, deleteDoc, query, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // ✅ CONFIGURAÇÃO DO FIREBASE CORRIGIDA E INSERIDA
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBJOANW80V8EyUQ3LbNqwJ8-91DfIp5ho8",
            authDomain: "gerenciadorturma.firebaseapp.com",
            projectId: "gerenciadorturma",
            storageBucket: "gerenciadorturma.appspot.com", // CORRIGIDO
            messagingSenderId: "610656492633",
            appId: "1:610656492633:web:32a0451c02048b6b1fe548",
            measurementId: "G-5JZXJSMGGL"
        };
        
        // =================================================================================
        // ⚠️ AÇÃO NECESSÁRIA: CLOUD FUNCTION PARA EXCLUIR USUÁRIOS ⚠️
        // Lembre-se, para a exclusão de usuários funcionar 100%, siga estes passos:
        // 1. Instale o Firebase CLI: `npm install -g firebase-tools`
        // 2. No seu terminal, navegue para a pasta do seu projeto e rode: `firebase init functions`
        // 3. Adicione o seguinte código ao arquivo `index.js` na pasta `functions`:
        /*
            const functions = require("firebase-functions");
            const admin = require("firebase-admin");
            admin.initializeApp();

            exports.onUserDeleted = functions.firestore
              .document("users/{userId}")
              .onDelete(async (snap, context) => {
                const userId = context.params.userId;
                console.log(`Deletando conta de autenticação para o UID: ${userId}`);
                try {
                  await admin.auth().deleteUser(userId);
                  console.log(`Conta de autenticação para o UID: ${userId} foi deletada.`);
                } catch (error) {
                  console.error(`Erro ao deletar conta para UID: ${userId}`, error);
                }
              });
        */
        // 4. Implante a função com o comando: `firebase deploy --only functions`
        // =================================================================================

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.projectId;

        let currentUserData = null;
        let unsubscribes = [];
        let fetchedAssets = { machines: [], parts: [], tools: [] };

        const ui = {
            authContainer: document.getElementById('auth-container'),
            loginScreen: document.getElementById('login-screen'),
            registerScreen: document.getElementById('register-screen'),
            loginForm: document.getElementById('login-form'),
            registerForm: document.getElementById('register-form'),
            showLoginBtn: document.getElementById('show-login'),
            showRegisterBtn: document.getElementById('show-register'),
            mainApp: document.getElementById('main-app'),
            userNameDisplay: document.getElementById('user-name'),
            userIdDisplay: document.getElementById('user-id-display-main'),
            logoutButton: document.getElementById('logout-button'),
            adminView: document.getElementById('admin-view'),
            userView: document.getElementById('user-view'),
            newFormButton: document.getElementById('new-form-button'),
            userFormsList: document.getElementById('user-forms-list'),
            maintenanceFormContainer: document.getElementById('maintenance-form-container'),
            userAssetManagement: document.getElementById('user-asset-management'),
            userAssetTabs: document.getElementById('user-asset-tabs'),
            userAssetContent: document.getElementById('user-asset-content'),
            modalContainer: document.getElementById('modal-container'),
        };
        
        const closeModal = () => ui.modalContainer.innerHTML = '';
        function showToast(message, type = 'info') {
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 text-white py-3 px-5 rounded-lg shadow-xl ${colors[type]} transform translate-y-20 opacity-0 transition-all duration-300 z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.remove('translate-y-20', 'opacity-0'), 10);
            setTimeout(() => { toast.classList.add('translate-y-20', 'opacity-0'); setTimeout(() => toast.remove(), 3000); }, 3000);
        }
        const showSuccess = (msg) => showToast(msg, 'success');
        const showError = (msg) => showToast(msg, 'error');
        function createIconsSafely() {
            try { if (window.lucide) window.lucide.createIcons(); }
            catch (e) { console.warn("Lucide library not ready.", e); }
        }

        const statusStyles = {
            'Aguardando': 'bg-yellow-500/20 text-yellow-400 border-yellow-500',
            'Em Andamento': 'bg-blue-500/20 text-blue-400 border-blue-500',
            'Finalizada': 'bg-green-500/20 text-green-400 border-green-500',
            'default': 'bg-gray-500/20 text-gray-400 border-gray-500'
        };

        onAuthStateChanged(auth, (user) => {
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];
            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const unsub = onSnapshot(userDocRef, (userDocSnap) => {
                    if (userDocSnap.exists()) {
                        currentUserData = { uid: user.uid, ...userDocSnap.data() };
                        setupApp();
                    } else {
                        showError("Dados do usuário não encontrados. Deslogando.");
                        signOut(auth);
                    }
                });
                unsubscribes.push(unsub);
            } else {
                currentUserData = null;
                showAuth();
            }
        });

        ui.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = ui.loginForm['login-email'].value;
            const password = ui.loginForm['login-password'].value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showError("Falha no login: " + error.message);
            }
        });

        ui.registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = ui.registerForm['register-name'].value;
            const email = ui.registerForm['register-email'].value;
            const phone = ui.registerForm['register-phone'].value;
            const password = ui.registerForm['register-password'].value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userDocRef = doc(db, 'users', user.uid);
                const newUser = {
                    name, email, phone, role: 'user',
                    permissions: { canCreateMachines: false, canCreateTools: false, canCreateParts: false }
                };
                await setDoc(userDocRef, newUser);
                showSuccess("Cadastro realizado com sucesso!");
                ui.registerForm.reset();
            } catch (error) {
                showError("Falha no cadastro: " + error.message);
                console.error("Register Error:", error);
            }
        });

        ui.logoutButton.addEventListener('click', () => signOut(auth));
        ui.showRegisterBtn.addEventListener('click', () => {
            ui.loginScreen.classList.add('hidden');
            ui.registerScreen.classList.remove('hidden');
        });
        ui.showLoginBtn.addEventListener('click', () => {
            ui.registerScreen.classList.add('hidden');
            ui.loginScreen.classList.remove('hidden');
        });

        function setupApp() {
            if (!currentUserData) return;
            ui.userNameDisplay.textContent = currentUserData.name;
            ui.userIdDisplay.textContent = currentUserData.uid;
            ui.mainApp.classList.remove('hidden');
            ui.authContainer.classList.add('hidden');
            if (currentUserData.role === 'admin') {
                setupAdminView();
            } else {
                setupUserView();
            }
            createIconsSafely();
        }

        function showAuth() {
            ui.mainApp.classList.add('hidden');
            ui.authContainer.classList.remove('hidden');
            ui.loginScreen.classList.remove('hidden');
            ui.registerScreen.classList.add('hidden');
        }

        async function fetchAssets() {
            try {
                const assets = { machines: [], parts: [], tools: [] };
                const collections = ['machines', 'parts', 'tools'];
                const promises = collections.map(c => getDocs(collection(db, `artifacts/${appId}/public/data/${c}`)));
                const [machinesSnap, partsSnap, toolsSnap] = await Promise.all(promises);
                machinesSnap.forEach(doc => assets.machines.push({ id: doc.id, ...doc.data() }));
                partsSnap.forEach(doc => assets.parts.push({ id: doc.id, ...doc.data() }));
                toolsSnap.forEach(doc => assets.tools.push({ id: doc.id, ...doc.data() }));
                fetchedAssets = assets;
                return assets;
            } catch (error) {
                console.error("Error fetching assets:", error);
                showError("Erro ao carregar os ativos.");
                return { machines: [], parts: [], tools: [] };
            }
        }

        // --- VIEWS SETUP ---
        function setupAdminView() {
            ui.userView.classList.add('hidden');
            ui.adminView.classList.remove('hidden');
            const navButtons = document.querySelectorAll('#admin-nav button');
            navButtons.forEach((button) => {
                button.addEventListener('click', (e) => {
                    navButtons.forEach(btn => {
                        btn.classList.remove('bg-orange-600', 'text-white');
                        btn.classList.add('hover:bg-gray-700');
                    });
                    const currentButton = e.currentTarget;
                    currentButton.classList.add('bg-orange-600', 'text-white');
                    currentButton.classList.remove('hover:bg-gray-700');
                    const targetId = currentButton.dataset.target;
                    document.querySelectorAll('.admin-tab-content').forEach(content => {
                        content.id === targetId ? content.classList.remove('hidden') : content.classList.add('hidden');
                    });
                });
            });
            
            if(document.querySelector('#admin-nav button.bg-orange-600') === null) {
                document.querySelector('#admin-nav button[data-target="admin-forms"]').click();
            } else {
                document.querySelector('#admin-nav button.bg-orange-600').click();
            }
            
            loadAdminContent('forms', 'Fichas de Manutenção', loadAdminForms);
            loadAdminContent('users', 'Gerenciar Usuários', loadAdminUsers);
            // CORRIGIDO: Chamando a função correta 'loadAssetList'
            loadAdminContent('machines', 'Gerenciar Máquinas', (c) => loadAssetList(c, 'machines', true));
            loadAdminContent('tools', 'Gerenciar Ferramentas', (c) => loadAssetList(c, 'tools', true));
            loadAdminContent('parts', 'Gerenciar Peças', (c) => loadAssetList(c, 'parts', true));
        }

        function setupUserView() {
            ui.adminView.classList.add('hidden');
            ui.userView.classList.remove('hidden');
            ui.maintenanceFormContainer.classList.add('hidden');

            const q = query(collection(db, `artifacts/${appId}/public/data/maintenance_forms`), where("creatorUid", "==", currentUserData.uid));
            const unsubForms = onSnapshot(q, (snapshot) => {
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().createdAt?.toMillis() || 0;
                    const timeB = b.data().createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                ui.userFormsList.innerHTML = snapshot.empty ? '<p class="text-gray-500">Nenhuma ficha encontrada.</p>' : '';
                sortedDocs.forEach(doc => {
                    const form = doc.data();
                    const latest = form.versions['v' + form.latestVersion];
                    const card = document.createElement('div');
                    
                    const formStatus = form.status || 'Aguardando';
                    const statusStyle = statusStyles[formStatus] || statusStyles['default'];
                    card.className = `flex flex-col md:flex-row items-start md:items-center gap-4 bg-gray-800 p-4 rounded-lg shadow-md border-l-4 ${statusStyle.split(' ')[2]}`;
                    
                    card.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-4 mb-2">
                                <p class="font-bold text-orange-500">${latest.tag || 'Sem TAG'}</p>
                                <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${statusStyle}">${formStatus}</span>
                            </div>
                            <p class="text-sm text-gray-300">${latest.equipamento || 'Equipamento não descrito'} (OS: ${latest.ordemServico || 'N/A'})</p>
                            <p class="text-xs text-gray-500">Versão: V${form.latestVersion} | Criado por: ${form.creatorName}</p>
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-2 self-end md:self-center">
                             <div class="flex gap-1">
                                 <button title="Aguardando" data-doc-id="${doc.id}" data-status="Aguardando" class="status-button p-2 rounded-md hover:bg-yellow-500/50 ${formStatus === 'Aguardando' ? 'bg-yellow-500/30' : ''}"><i data-lucide="pause-circle" class="w-4 h-4 text-yellow-400"></i></button>
                                 <button title="Em Andamento" data-doc-id="${doc.id}" data-status="Em Andamento" class="status-button p-2 rounded-md hover:bg-blue-500/50 ${formStatus === 'Em Andamento' ? 'bg-blue-500/30' : ''}"><i data-lucide="play-circle" class="w-4 h-4 text-blue-400"></i></button>
                                 <button title="Finalizada" data-doc-id="${doc.id}" data-status="Finalizada" class="status-button p-2 rounded-md hover:bg-green-500/50 ${formStatus === 'Finalizada' ? 'bg-green-500/30' : ''}"><i data-lucide="check-circle-2" class="w-4 h-4 text-green-400"></i></button>
                             </div>
                             <button class="edit-user-form-button bg-gray-700 text-white p-2 rounded-md hover:bg-gray-600"><i data-lucide="edit" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    card.querySelector('.edit-user-form-button').onclick = () => editMaintenanceForm(doc.id);
                    ui.userFormsList.appendChild(card);
                });
                createIconsSafely();
            });
            
            ui.userFormsList.addEventListener('click', (e) => {
                const button = e.target.closest('.status-button');
                if (button) {
                    const { docId, status } = button.dataset;
                    if (docId && status) {
                        updateFormStatus(docId, status);
                    }
                }
            });

            unsubscribes.push(unsubForms);
            setupUserAssetManagement();
        }
        
        async function updateFormStatus(formId, newStatus) {
            try {
                const formDocRef = doc(db, `artifacts/${appId}/public/data/maintenance_forms`, formId);
                await updateDoc(formDocRef, { status: newStatus });
                showSuccess(`Status da ficha atualizado para "${newStatus}"!`);
            } catch (e) {
                showError("Erro ao atualizar o status da ficha.");
                console.error("Erro ao atualizar status:", e);
            }
        }
        
        function setupUserAssetManagement() {
            const perms = currentUserData.permissions || {};
            ui.userAssetTabs.innerHTML = '';
            ui.userAssetContent.innerHTML = '';

            const permittedAssets = [
                { type: 'machines', label: 'Máquinas', perm: perms.canCreateMachines },
                { type: 'tools', label: 'Ferramentas', perm: perms.canCreateTools },
                { type: 'parts', label: 'Peças', perm: perms.canCreateParts },
            ].filter(asset => asset.perm);

            if (permittedAssets.length === 0) {
                ui.userAssetManagement.classList.add('hidden');
                return;
            }

            ui.userAssetManagement.classList.remove('hidden');
            permittedAssets.forEach((asset, index) => {
                const button = document.createElement('button');
                button.dataset.type = asset.type;
                button.textContent = asset.label;
                button.className = `px-4 py-2 text-sm font-medium rounded-t-lg transition-colors ${index === 0 ? 'bg-gray-800 border-x border-t border-gray-700 text-orange-500' : 'text-gray-400 hover:text-gray-100'}`;
                button.onclick = (e) => {
                    document.querySelectorAll('#user-asset-tabs button').forEach(btn => {
                        btn.className = 'px-4 py-2 text-sm font-medium rounded-t-lg transition-colors text-gray-400 hover:text-gray-100';
                    });
                    e.currentTarget.className = 'px-4 py-2 text-sm font-medium rounded-t-lg transition-colors bg-gray-800 border-x border-t border-gray-700 text-orange-500';
                    loadUserAssets(asset.type);
                };
                ui.userAssetTabs.appendChild(button);
            });

            if(ui.userAssetTabs.firstChild) ui.userAssetTabs.firstChild.click();
        }

        function loadUserAssets(assetType) {
            const container = ui.userAssetContent;
            container.innerHTML = `<h3 class="text-xl font-semibold text-gray-100 mb-4 flex justify-between items-center">Lista de ${assetType.charAt(0).toUpperCase() + assetType.slice(1)}</h3>`;
            const header = container.querySelector('h3');
            const button = document.createElement('button');
            button.className = "bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2";
            button.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> <span>Adicionar</span>`;
            button.onclick = () => manageAsset(assetType.slice(0, -1), null, false);
            header.appendChild(button);
            
            const listContainer = document.createElement('div');
            container.appendChild(listContainer);
            loadAssetList(listContainer, assetType, false);
            createIconsSafely();
        }


        // --- FUNÇÕES DE ADMIN ---
        function loadAdminContent(id, title, loaderFn) {
            const container = document.getElementById(`admin-${id}`);
            container.innerHTML = `<h2 class="text-2xl font-bold text-gray-100 mb-4">${title}</h2><div class="content-wrapper"></div>`;
            const isAsset = !['forms', 'users'].includes(id);
            if (isAsset) {
                const header = container.querySelector('h2');
                const button = document.createElement('button');
                button.className = "bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 flex items-center gap-2";
                button.innerHTML = `<i data-lucide="plus" class="w-4 h-4"></i> <span>Adicionar</span>`;
                button.onclick = () => manageAsset(id.slice(0, -1), null, true);
                header.classList.add('flex', 'justify-between', 'items-center');
                header.appendChild(button);
            }
            loaderFn(container.querySelector('.content-wrapper'));
            createIconsSafely();
        }
        
        function loadAdminForms(container) {
            const q = query(collection(db, `artifacts/${appId}/public/data/maintenance_forms`));
            const unsub = onSnapshot(q, (snapshot) => {
                container.innerHTML = snapshot.empty ? '<p class="text-gray-500">Nenhuma ficha encontrada.</p>' : '<div class="space-y-3"></div>';
                if(snapshot.empty) return;
                const list = container.querySelector('.space-y-3');
                snapshot.docs.sort((a,b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0)).forEach(doc => {
                    const form = doc.data();
                    const latest = form.versions['v' + form.latestVersion];
                    const card = document.createElement('div');
                    card.className = "bg-gray-900 p-3 rounded-lg border border-gray-700 flex justify-between items-center hover:bg-gray-700 cursor-pointer";
                    card.innerHTML = `<div><p class="font-semibold text-orange-500">${latest.tag || 'Sem TAG'} - <span class="font-normal text-gray-300">${latest.equipamento || 'Sem Descrição'}</span></p><p class="text-sm text-gray-400">Por: ${form.creatorName} <span class="text-xs text-gray-500 ml-2">V${form.latestVersion}</span></p></div><i data-lucide="chevron-right" class="w-5 h-5"></i>`;
                    card.onclick = () => viewFormDetails(doc.id);
                    list.appendChild(card);
                });
                createIconsSafely();
            });
            unsubscribes.push(unsub);
        }

        function loadAdminUsers(container) {
            const q = collection(db, 'users');
            const unsub = onSnapshot(q, (snapshot) => {
                container.innerHTML = snapshot.empty ? '<p class="text-gray-500">Nenhum usuário encontrado.</p>' : '<div class="space-y-3"></div>';
                if(snapshot.empty) return;
                const list = container.querySelector('.space-y-3');
                snapshot.forEach(doc => {
                    const user = { id: doc.id, ...doc.data() };
                    if (user.id === currentUserData.uid) return;
                    const card = document.createElement('div');
                    card.className = "bg-gray-900 p-3 rounded-lg border border-gray-700 flex justify-between items-center";
                    card.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-100">${user.name} <span class="text-xs ml-2 px-2 py-0.5 rounded-full ${user.role === 'admin' ? 'bg-orange-600' : 'bg-gray-600'}">${user.role}</span></p>
                            <p class="text-sm text-gray-400">${user.email}</p>
                        </div>
                        <div class="flex items-center gap-2">
                           <button class="edit-user-button p-2 text-blue-500 hover:bg-blue-900/50 rounded-md"><i data-lucide="edit"></i></button>
                           <button class="delete-user-button p-2 text-red-500 hover:bg-red-900/50 rounded-md"><i data-lucide="trash-2"></i></button>
                        </div>
                    `;
                    card.querySelector('.edit-user-button').onclick = () => manageUserPermissions(user);
                    card.querySelector('.delete-user-button').onclick = () => deleteUser(user.id, user.name);
                    list.appendChild(card);
                });
                createIconsSafely();
            });
            unsubscribes.push(unsub);
        }

        async function deleteUser(userId, userName) {
            if (window.confirm(`Tem certeza que deseja EXCLUIR PERMANENTEMENTE o usuário "${userName}"?\n\nEsta ação removerá os dados do usuário do sistema e sua conta de login. A ação não pode ser desfeita.`)) {
                try {
                    await deleteDoc(doc(db, 'users', userId));
                    showSuccess(`Usuário "${userName}" excluído. A conta de login será removida em breve pela rotina de backend.`);
                } catch (e) {
                    showError("Erro ao excluir o documento do usuário.");
                    console.error("Erro ao excluir usuário do Firestore:", e);
                }
            }
        }
        
        function manageUserPermissions(user) {
            const p = user.permissions || {};
            const title = `Gerenciar ${user.name}`;
            const content = `<form id="permissions-form" class="space-y-4"><p class="text-gray-400">Defina o cargo e as permissões de criação para este usuário.</p><div><label class="font-semibold text-gray-300">Cargo</label><select name="role" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded"><option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuário</option><option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option></select></div><div class="border-t border-gray-700 pt-4"><h4 class="font-semibold text-gray-300 mb-2">Permissões de Criação</h4><div class="space-y-2"><label class="flex items-center gap-2"><input type="checkbox" name="canCreateMachines" ${p.canCreateMachines ? 'checked' : ''} class="w-4 h-4 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">Pode criar máquinas</label><label class="flex items-center gap-2"><input type="checkbox" name="canCreateTools" ${p.canCreateTools ? 'checked' : ''} class="w-4 h-4 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">Pode criar ferramentas</label><label class="flex items-center gap-2"><input type="checkbox" name="canCreateParts" ${p.canCreateParts ? 'checked' : ''} class="w-4 h-4 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">Pode criar peças</label></div></div></form>`;
            const footer = `<button id="cancel-modal" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-500">Cancelar</button><button id="save-permissions" class="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700">Salvar Alterações</button>`;
            ui.modalContainer.innerHTML = createModalHTML(title, content, footer);
            document.getElementById('cancel-modal').onclick = closeModal;
            document.getElementById('close-modal-button').onclick = closeModal;
            document.getElementById('save-permissions').onclick = async () => {
                const form = document.getElementById('permissions-form');
                const newRole = form.elements.role.value;
                const newPermissions = {
                    canCreateMachines: form.elements.canCreateMachines.checked,
                    canCreateTools: form.elements.canCreateTools.checked,
                    canCreateParts: form.elements.canCreateParts.checked,
                };
                try {
                    const userDocRef = doc(db, 'users', user.id);
                    await updateDoc(userDocRef, { role: newRole, permissions: newPermissions });
                    showSuccess("Permissões atualizadas com sucesso!");
                    closeModal();
                } catch(e) {
                    showError("Erro ao atualizar permissões.");
                    console.error(e);
                }
            };
        }
        
        function loadAssetList(container, collectionName, isAdmin) {
            const q = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
            const unsub = onSnapshot(q, (snapshot) => {
                container.innerHTML = snapshot.empty ? '<p class="text-gray-500 mt-4">Nenhum item encontrado.</p>' : '<div class="space-y-2 mt-4"></div>';
                if(snapshot.empty) return;
                const list = container.querySelector('.space-y-2');
                snapshot.forEach(doc => {
                    list.appendChild(renderAssetCard(doc.id, doc.data(), collectionName.slice(0, -1), isAdmin));
                });
                createIconsSafely();
            });
            unsubscribes.push(unsub);
        }
        
        function renderAssetCard(id, data, type, isAdmin) {
            let content = '';
            switch(type) {
                case 'machine': content = `<p class="font-bold text-gray-100">${data.tag || 'N/A'}</p><p class="text-sm text-gray-400">${data.description || 'Sem descrição'}</p>`; break;
                case 'tool': content = `<p class="font-bold text-gray-100">${data.name || 'N/A'}</p><p class="text-sm text-gray-400">Quantidade: ${data.quantity || 0}</p>`; break;
                case 'part': content = `<p class="font-bold text-gray-100">${data.description || 'N/A'}</p><p class="text-sm text-gray-400">Código: ${data.code || 'N/A'} | Quantidade: ${data.quantity || 0}</p>`; break;
            }
            const item = document.createElement('div');
            item.className = "bg-gray-900 p-3 rounded-lg border border-gray-700 flex justify-between items-center";
            item.innerHTML = `<div>${content}</div> ${isAdmin ? `<div class="flex gap-2"><button class="edit-asset-button p-2 text-blue-500 hover:bg-blue-900/50 rounded-md"><i data-lucide="edit"></i></button><button class="delete-asset-button p-2 text-red-500 hover:bg-red-900/50 rounded-md"><i data-lucide="trash-2"></i></button></div>` : ''}`;
            if(isAdmin) {
                item.querySelector('.edit-asset-button').onclick = () => manageAsset(type, id, true);
                item.querySelector('.delete-asset-button').onclick = () => deleteAsset(`${type}s`, id);
            }
            return item;
        }

        async function manageAsset(type, id = null, isAdmin) {
            const data = id ? (await getDoc(doc(db, `artifacts/${appId}/public/data/${type}s`, id))).data() : {};
            let title, contentHTML;
            const inputClass = "w-full p-2 bg-gray-900 border border-gray-600 rounded";
            
            switch(type) {
                case 'machine':
                    title = id ? 'Editar Máquina' : 'Adicionar Máquina';
                    contentHTML = `<form id="asset-form" class="space-y-4"><div><label class="text-gray-300">TAG:</label><input name="tag" class="${inputClass}" value="${data.tag || ''}" required></div><div><label class="text-gray-300">Descrição:</label><input name="description" class="${inputClass}" value="${data.description || ''}" required></div></form>`;
                    break;
                case 'tool':
                    title = id ? 'Editar Ferramenta' : 'Adicionar Ferramenta';
                    contentHTML = `<form id="asset-form" class="space-y-4"><div><label class="text-gray-300">Nome:</label><input name="name" class="${inputClass}" value="${data.name || ''}" required></div><div><label class="text-gray-300">Quantidade:</label><input type="number" name="quantity" class="${inputClass}" value="${data.quantity || '0'}" required></div></form>`;
                    break;
                case 'part':
                    title = id ? 'Editar Peça' : 'Adicionar Peça';
                    contentHTML = `<form id="asset-form" class="space-y-4"><div><label class="text-gray-300">Código:</label><input name="code" class="${inputClass}" value="${data.code || ''}" required></div><div><label class="text-gray-300">Descrição:</label><input name="description" class="${inputClass}" value="${data.description || ''}" required></div><div><label class="text-gray-300">Quantidade:</label><input type="number" name="quantity" class="${inputClass}" value="${data.quantity || '0'}" required></div></form>`;
                    break;
            }
            const footerHTML = `<button id="cancel-modal" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg mr-2 hover:bg-gray-500">Cancelar</button><button id="save-asset" class="bg-orange-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-700">Salvar</button>`;
            ui.modalContainer.innerHTML = createModalHTML(title, contentHTML, footerHTML);
            document.getElementById('cancel-modal').onclick = closeModal;
            document.getElementById('close-modal-button').onclick = closeModal;
            document.getElementById('save-asset').onclick = async () => {
                const form = document.getElementById('asset-form');
                if (form.checkValidity()) {
                    const formData = new FormData(form);
                    const dataToSave = {};
                    formData.forEach((value, key) => { dataToSave[key] = isNaN(Number(value)) || value === '' || key === 'code' || key === 'tag' ? value : Number(value); });
                    try {
                        const collectionName = `${type}s`;
                        if (id) {
                            await setDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, id), dataToSave);
                            showSuccess("Item atualizado com sucesso!");
                        } else {
                            await addDoc(collection(db, `artifacts/${appId}/public/data/${collectionName}`), dataToSave);
                            showSuccess("Item adicionado com sucesso!");
                        }
                        closeModal();
                    } catch(e) { console.error("Erro ao salvar:", e); showError("Falha ao salvar o item."); }
                } else {
                    form.reportValidity();
                }
            };
        }
        
        async function deleteAsset(collectionName, id) {
            if (window.confirm("Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.")) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, id));
                    showSuccess("Item excluído com sucesso.");
                } catch(e) { console.error("Erro ao excluir:", e); showError("Falha ao excluir o item."); }
            }
        }
        
        // --- Funções do Formulário de Manutenção ---
        ui.newFormButton.addEventListener('click', async () => {
            try {
                showToast("Carregando dados...", "info");
                const assets = await fetchAssets();
                ui.maintenanceFormContainer.innerHTML = createMaintenanceFormHTML({}, null, 1, assets);
                ui.maintenanceFormContainer.classList.remove('hidden');
                ui.maintenanceFormContainer.scrollIntoView({ behavior: 'smooth' });
                attachFormListeners(assets);
            } catch(e) {
                showError("Erro ao carregar dados do formulário.");
                console.error(e);
            }
        });

        async function editMaintenanceForm(formId) {
            try {
                showToast("Carregando dados...", "info");
                const assets = await fetchAssets();
                const docRef = doc(db, `artifacts/${appId}/public/data/maintenance_forms`, formId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const latest = data.versions['v' + data.latestVersion];
                    ui.maintenanceFormContainer.innerHTML = createMaintenanceFormHTML(latest, formId, data.latestVersion, assets);
                    ui.maintenanceFormContainer.classList.remove('hidden');
                    ui.maintenanceFormContainer.scrollIntoView({ behavior: 'smooth' });
                    attachFormListeners(assets);
                } else showError("Ficha não encontrada.");
            } catch (e) {
                showError("Erro ao carregar dados do formulário.");
                console.error(e);
            }
        }

        function attachFormListeners(assets) {
            const form = document.getElementById('maintenance-form');
            form.addEventListener('submit', handleFormSubmit);
            document.getElementById('cancel-form-button').onclick = () => {
                ui.maintenanceFormContainer.classList.add('hidden');
                ui.maintenanceFormContainer.innerHTML = '';
            };
            document.getElementById('tag-select').onchange = (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                document.getElementById('equipamento-description').value = selectedOption.dataset.description || '';
            };
            const setupRowListeners = (tableBody) => {
                tableBody.querySelectorAll('.remove-row-button').forEach(btn => btn.onclick = (e) => e.target.closest('tr').remove());
                tableBody.querySelectorAll('.part-select').forEach(sel => sel.onchange = (e) => {
                    const part = assets.parts.find(p => p.id === e.target.value);
                    e.target.closest('tr').querySelector('[name="pecaCodigo"]').value = part ? part.code : '';
                });
            };
            document.getElementById('add-mao-de-obra').onclick = () => {
                const tableBody = document.querySelector('#mao-de-obra-table tbody');
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `<td class="p-2"><input type="text" name="maoObraNome" class="w-full p-2 bg-gray-900 border border-gray-600 rounded"></td><td class="p-2"><input type="text" name="maoObraCodigo" class="w-full p-2 bg-gray-900 border border-gray-600 rounded"></td><td class="p-2 text-center"><button type="button" class="remove-row-button text-red-500 hover:text-red-700 text-2xl">&times;</button></td>`;
                setupRowListeners(document.querySelector('#mao-de-obra-table'));
            };
            document.getElementById('add-peca-utilizada').onclick = () => {
                const tableBody = document.querySelector('#pecas-utilizadas-table tbody');
                const newRow = tableBody.insertRow();
                newRow.innerHTML = createPecaRowHTML({}, assets.parts);
                setupRowListeners(document.querySelector('#pecas-utilizadas-table'));
            };
            setupRowListeners(form);
        }

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formId = form.dataset.id;
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                if (!key.startsWith('maoObra') && !key.startsWith('peca')) {
                    if (form.elements[key].type === 'checkbox' && !key.startsWith('tipoServico')) continue;
                    data[key] = value;
                }
            }
            data.tipoServico = formData.getAll('tipoServico');
            data.parouMaquina = form.elements.parouMaquina.checked;
            data.maoDeObra = Array.from(document.querySelectorAll('#mao-de-obra-table tbody tr')).map(row => ({
                nome: row.querySelector('[name="maoObraNome"]').value,
                codigo: row.querySelector('[name="maoObraCodigo"]').value
            })).filter(item => item.nome || item.codigo);
            data.pecasUtilizadas = Array.from(document.querySelectorAll('#pecas-utilizadas-table tbody tr')).map(row => {
                const pecaId = row.querySelector('[name="pecaId"]').value;
                const selectedPart = fetchedAssets.parts.find(p => p.id === pecaId);
                return {
                    partId: pecaId,
                    codigo: selectedPart ? selectedPart.code : '',
                    descricao: selectedPart ? selectedPart.description : '',
                    qtd: row.querySelector('[name="pecaQtd"]').value,
                };
            }).filter(item => item.partId && item.qtd);
            
            try {
                if (formId) {
                    const formDocRef = doc(db, `artifacts/${appId}/public/data/maintenance_forms`, formId);
                    const formDoc = await getDoc(formDocRef);
                    if (formDoc.exists()) {
                        const existingData = formDoc.data();
                        const newVersion = existingData.latestVersion + 1;
                        await updateDoc(formDocRef, {
                           latestVersion: newVersion,
                           [`versions.v${newVersion}`]: data,
                           updatedAt: serverTimestamp()
                        });
                        showSuccess("Ficha atualizada para V" + newVersion);
                    }
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/maintenance_forms`), {
                        creatorUid: currentUserData.uid,
                        creatorName: currentUserData.name,
                        createdAt: serverTimestamp(),
                        latestVersion: 1,
                        status: 'Aguardando',
                        versions: { v1: data }
                    });
                    showSuccess("Ficha criada com sucesso!");
                }
                ui.maintenanceFormContainer.classList.add('hidden');
                ui.maintenanceFormContainer.innerHTML = '';
            } catch (error) {
                console.error("Erro ao salvar ficha:", error);
                showError("Ocorreu um erro ao salvar.");
            }
        }
        
        function createMaintenanceFormHTML(data = {}, formId = null, version = 1, assets) {
            const d = (key) => data[key] || '';
            const dt = (key) => (data[key] ? new Date(data[key]).toISOString().slice(0, 16) : '');
            const machineOptions = assets.machines.map(m => `<option value="${m.tag}" data-description="${m.description}" ${d('tag') === m.tag ? 'selected' : ''}>${m.tag} - ${m.description}</option>`).join('');
            const pecasUtilizadasRows = (data.pecasUtilizadas || []).map(item => createPecaRowHTML(item, assets.parts)).join('');
            return `<form id="maintenance-form" data-id="${formId || ''}" data-version="${version}" class="space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="font-semibold text-gray-300">Nº Ordem Serviço:</label><input type="text" name="ordemServico" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md" value="${d('ordemServico')}"></div><div><label class="font-semibold text-gray-300">TAG (Máquina):</label><select name="tag" id="tag-select" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md"><option value="">Selecione uma máquina</option>${machineOptions}</select></div><div class="md:col-span-3"><label class="font-semibold text-gray-300">Descrição do equipamento:</label><input type="text" id="equipamento-description" name="equipamento" class="w-full mt-1 p-2 bg-gray-800 border border-gray-600 rounded-md" value="${d('equipamento')}" readonly></div></div><h3 class="form-section-title">Detalhes da Solicitação</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label class="font-semibold text-gray-300">Motivo:</label><input type="text" name="motivo" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md" value="${d('motivo')}"></div><div><label class="font-semibold text-gray-300">Tipo de serviço:</label><div class="flex flex-wrap gap-x-4 gap-y-2 mt-2">${['CORRETIVA', 'PREVENTIVA', 'MELHORIA', 'PREDIAL'].map(type => `<label class="flex items-center gap-2"><input type="checkbox" name="tipoServico" value="${type}" ${(d('tipoServico') || []).includes(type) ? 'checked' : ''} class="w-4 h-4 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500">${type}</label>`).join('')}</div></div><div class="flex items-center"><label class="flex items-center gap-2 font-semibold text-gray-300"><input type="checkbox" name="parouMaquina" class="w-5 h-5 text-orange-600 bg-gray-700 border-gray-600 rounded focus:ring-orange-500" ${d('parouMaquina') ? 'checked' : ''}>Parou a máquina?</label></div><div class="md:col-span-2"><label class="font-semibold text-gray-300">Causa:</label><textarea name="causa" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md h-24">${d('causa')}</textarea></div></div><h3 class="form-section-title">Descrição dos Serviços</h3><div class="space-y-4"><div><label class="font-semibold text-gray-300">Descrição do serviço a ser realizado:</label><textarea name="servicoRealizar" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md h-24">${d('servicoRealizar')}</textarea></div><div><label class="font-semibold text-gray-300">Descrição do serviço realizado:</label><textarea name="servicoRealizado" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md h-24">${d('servicoRealizado')}</textarea></div></div><h3 class="form-section-title">Mão de Obra</h3><table id="mao-de-obra-table" class="w-full text-sm"><thead><tr class="border-b border-gray-700"><th class="p-2 text-left">Nome</th><th class="p-2 text-left">Código</th><th class="w-12"></th></tr></thead><tbody>${(data.maoDeObra || []).map(item => `<tr class="border-b border-gray-700"><td class="p-2"><input type="text" name="maoObraNome" class="w-full p-2 bg-gray-900 border border-gray-600 rounded" value="${item.nome || ''}"></td><td class="p-2"><input type="text" name="maoObraCodigo" class="w-full p-2 bg-gray-900 border border-gray-600 rounded" value="${item.codigo || ''}"></td><td class="p-2 text-center"><button type="button" class="remove-row-button text-red-500 hover:text-red-700 text-2xl">&times;</button></td></tr>`).join('') || ''}</tbody></table><button type="button" id="add-mao-de-obra" class="mt-2 text-orange-500 font-semibold text-sm hover:text-orange-400">+ Adicionar Mão de Obra</button><h3 class="form-section-title">Peças Utilizadas</h3><table id="pecas-utilizadas-table" class="w-full text-sm"><thead><tr class="border-b border-gray-700"><th class="p-2 text-left">Peça</th><th class="p-2 text-left">Código</th><th class="p-2 text-left w-24">Qtd.</th><th class="w-12"></th></tr></thead><tbody>${pecasUtilizadasRows}</tbody></table><button type="button" id="add-peca-utilizada" class="mt-2 text-orange-500 font-semibold text-sm hover:text-orange-400">+ Adicionar Peça</button><h3 class="form-section-title">Controle de Tempo</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4"><div><label class="font-semibold text-sm text-gray-300">Início Ocorrência:</label><input type="datetime-local" name="inicioOcorrencia" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md text-sm" value="${dt('inicioOcorrencia')}"></div><div><label class="font-semibold text-sm text-gray-300">Início Conserto:</label><input type="datetime-local" name="inicioConserto" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md text-sm" value="${dt('inicioConserto')}"></div><div><label class="font-semibold text-sm text-gray-300">Fim Conserto:</label><input type="datetime-local" name="fimConserto" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md text-sm" value="${dt('fimConserto')}"></div><div><label class="font-semibold text-sm text-gray-300">Fim Ocorrência:</label><input type="datetime-local" name="fimOcorrencia" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md text-sm" value="${dt('fimOcorrencia')}"></div></div><h3 class="form-section-title">Assinaturas</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="font-semibold text-gray-300">Visto Executante:</label><input type="text" name="vistoExecutante" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md" value="${d('vistoExecutante')}"></div><div><label class="font-semibold text-gray-300">Data:</label><input type="date" name="dataVistoExecutante" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md" value="${d('dataVistoExecutante')}"></div><div><label class="font-semibold text-gray-300">Visto Responsável:</label><input type="text" name="vistoResponsavel" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md" value="${d('vistoResponsavel')}"></div><div><label class="font-semibold text-gray-300">Data:</label><input type="date" name="dataVistoResponsavel" class="w-full mt-1 p-2 bg-gray-900 border border-gray-600 rounded-md" value="${d('dataVistoResponsavel')}"></div></div><div class="mt-8 flex justify-end gap-4"><button type="button" id="cancel-form-button" class="bg-gray-600 text-gray-200 font-bold py-2 px-6 rounded-lg hover:bg-gray-500">Cancelar</button><button type="submit" class="bg-orange-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-orange-700">Salvar Ficha</button></div></form>`;
        }
        function createPecaRowHTML(item = {}, parts = []) {
            const partOptions = parts.map(p => `<option value="${p.id}" ${item.partId === p.id ? 'selected' : ''}>${p.description} (Cód: ${p.code})</option>`).join('');
            return `<tr class="border-b border-gray-700"><td class="p-2"><select name="pecaId" class="part-select w-full p-2 bg-gray-900 border border-gray-600 rounded"><option value="">Selecione</option>${partOptions}</select></td><td class="p-2"><input type="text" name="pecaCodigo" class="w-full p-2 bg-gray-800 border border-gray-600 rounded" value="${item.codigo || ''}" readonly></td><td class="p-2"><input type="number" name="pecaQtd" class="w-full p-2 bg-gray-900 border border-gray-600 rounded" value="${item.qtd || ''}"></td><td class="p-2 text-center"><button type="button" class="remove-row-button text-red-500 hover:text-red-700 text-2xl">&times;</button></td></tr>`;
        }
        function createModalHTML(title, content, footer) {
            return `<div class="modal-backdrop" id="modal-backdrop"><div class="bg-gray-800 rounded-xl shadow-2xl w-11/12 md:w-3/4 lg:w-2/3 modal-content flex flex-col border border-gray-700"><header class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-bold text-gray-100">${title}</h3><button id="close-modal-button" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button></header><main class="p-6 overflow-y-auto">${content}</main><footer class="p-4 border-t border-gray-700 bg-gray-900/50 flex justify-end">${footer}</footer></div></div>`;
        }
        async function viewFormDetails(formId) {
            const docRef = doc(db, `artifacts/${appId}/public/data/maintenance_forms`, formId);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) return showError("Ficha não encontrada.");
            const form = docSnap.data();
            const versionsHTML = Object.keys(form.versions).sort((a,b) => b.slice(1) - a.slice(1)).map(v_key => `<option value="${v_key}" ${'v' + form.latestVersion == v_key ? 'selected' : ''}>Versão ${v_key.slice(1)}</option>`).join('');
            const content = `<div class="mb-4"><label class="font-semibold text-gray-300">Selecione a Versão:</label><select id="version-selector" class="p-2 bg-gray-900 border border-gray-600 rounded-md ml-2">${versionsHTML}</select></div><div id="form-details-content"></div>`;
            ui.modalContainer.innerHTML = createModalHTML('Detalhes da Ficha', content, `<button id="close-modal-footer" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500">Fechar</button>`);
            const versionSelector = document.getElementById('version-selector');
            const detailsContent = document.getElementById('form-details-content');
            const renderVersionDetails = (versionKey) => {
                const data = form.versions[versionKey];
                const p = (label, value) => `<div class="py-1"><strong class="text-gray-400">${label}:</strong> ${value || 'N/A'}</div>`;
                detailsContent.innerHTML = `<div class="space-y-3 text-sm text-gray-300">${p('OS Nº', data.ordemServico)}<div class="grid grid-cols-1 md:grid-cols-2 gap-x-4"> ${p('TAG', data.tag)} ${p('Equipamento', data.equipamento)} </div>${p('Motivo', data.motivo)}${p('Tipo Serviço', (data.tipoServico || []).join(', '))}${p('Parou a Máquina?', data.parouMaquina ? 'Sim' : 'Não')}<div class="prose mt-1 p-2 bg-gray-900 rounded"><strong class="text-gray-400">Causa:</strong><div>${data.causa || 'N/A'}</div></div><div class="prose mt-1 p-2 bg-gray-900 rounded"><strong class="text-gray-400">Serviço a Realizar:</strong><div>${data.servicoRealizar || 'N/A'}</div></div><div class="prose mt-1 p-2 bg-gray-900 rounded"><strong class="text-gray-400">Serviço Realizado:</strong><div>${data.servicoRealizado || 'N/A'}</div></div><div><strong>Mão de Obra:</strong><ul class="list-disc pl-5 mt-1">${(data.maoDeObra || []).map(i => `<li>${i.nome} (${i.codigo})</li>`).join('') || '<li>N/A</li>'}</ul></div><div><strong>Peças:</strong><ul class="list-disc pl-5 mt-1">${(data.pecasUtilizadas || []).map(i => `<li>${i.qtd}x ${i.descricao} (${i.codigo})</li>`).join('') || '<li>N/A</li>'}</ul></div><div><strong>Controle de Tempo:</strong><div class="grid grid-cols-2 gap-x-4">${p('In. Ocorrência', data.inicioOcorrencia)} ${p('In. Conserto', data.inicioConserto)} ${p('Fim Conserto', data.fimConserto)} ${p('Fim Ocorrência', data.fimOcorrencia)}</div></div><div><strong>Assinaturas:</strong><div class="grid grid-cols-2 gap-x-4">${p('Executante', `${data.vistoExecutante || ''} em ${data.dataVistoExecutante || ''}`)} ${p('Responsável', `${data.vistoResponsavel || ''} em ${data.dataVistoResponsavel || ''}`)}</div></div></div>`;
            };
            renderVersionDetails(versionSelector.value);
            versionSelector.addEventListener('change', (e) => renderVersionDetails(e.target.value));
            document.getElementById('close-modal-button').onclick = closeModal;
            document.getElementById('close-modal-footer').onclick = closeModal;
        }

    </script>
</body>
</html>
